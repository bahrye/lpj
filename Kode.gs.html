const ID_DB_MASTER = "1e1V7DQjOWRnx9KETszXwYYDCKAMeUfI3z9In9fM1fxM"; 
const ID_TEMPLATE = "126RPw6wPoUmPgYt16jyzd1EY-ma5xGFr8WoRSQoShUw"; 

function doGet(e) {
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setTitle('Sistem LPJ BOS Terpadu')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

// --- FUNGSI BANTUAN: CEK & BUAT SHEET OTOMATIS ---
function ensureSheetExists(ss, sheetName) {
  let sheet = ss.getSheetByName(sheetName);
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    if (sheetName === "Data_Toko") {
      sheet.appendRow(["Nama Toko", "Jenis Toko", "Alamat Toko", "No. Telp", "Pemilik", "Tanggal TTD"]);
    } else if (sheetName === "Data_Uraian") {
      sheet.appendRow(["Kode Rekening", "Nama Uraian Belanja"]);
    } else if (sheetName === "Data_Tukang") {
      sheet.appendRow(["Nama Tukang", "Alamat Tukang"]);
    }
    sheet.getRange(1, 1, 1, sheet.getLastColumn()).setFontWeight("bold");
  }
  return sheet;
}

// --- AUTH ---
function registerUser(form) {
  const ssMaster = SpreadsheetApp.openById(ID_DB_MASTER).getSheetByName("Users");
  const data = ssMaster.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][2] == form.email) return { status: "error", message: "Email sudah terdaftar!" };
  }
  try {
    const templateFile = DriveApp.getFileById(ID_TEMPLATE);
    const newFile = templateFile.makeCopy("DB BOS - " + form.sekolah);
    newFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.EDITOR);
    ssMaster.appendRow([new Date(), form.sekolah, form.email, form.password, newFile.getId()]);
    return { status: "success", message: "Registrasi Berhasil! Silakan Login." };
  } catch (e) {
    return { status: "error", message: "Gagal membuat database: " + e.toString() };
  }
}

function loginUser(form) {
  const ssMaster = SpreadsheetApp.openById(ID_DB_MASTER).getSheetByName("Users");
  const data = ssMaster.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][2] == form.email && data[i][3] == form.password) {
      return { status: "success", token: data[i][4], sekolah: data[i][1] }; 
    }
  }
  return { status: "error", message: "Email atau Password salah!" };
}

// --- DATA HANDLERS ---
function getDataSekolah(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId).getSheetByName("Data_Sekolah");
    const data = ss.getDataRange().getValues();
    let result = {};
    data.forEach(row => { if(row[0]) result[row[0]] = row[1]; });
    return result;
  } catch(e) { return {}; }
}

function saveDataSekolah(dbId, formObj) {
  const ss = SpreadsheetApp.openById(dbId).getSheetByName("Data_Sekolah");
  ss.clear(); 
  const entries = Object.entries(formObj);
  if(entries.length > 0) ss.getRange(1, 1, entries.length, 2).setValues(entries);
  return "Data Sekolah Berhasil Disimpan!";
}

function getAllMasterData(dbId, sheetName) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, sheetName);
    const lr = sheet.getLastRow();
    if (lr <= 1) return [];
    
    // Ambil semua data
    let data = sheet.getRange(2, 1, lr - 1, sheet.getLastColumn()).getValues();
    
    // --- PERBAIKAN: KONVERSI TANGGAL ---
    data = data.map(row => {
      return row.map(cell => {
        if (Object.prototype.toString.call(cell) === '[object Date]') {
          try {
            return cell.toISOString().split('T')[0];
          } catch (e) {
            return ""; 
          }
        }
        return cell;
      });
    });

    return data; 
  } catch (e) { 
    return []; 
  }
}

function saveMasterData(dbId, sheetName, dataArray, rowIndex) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, sheetName);
    if (rowIndex !== "" && rowIndex !== null && rowIndex !== undefined) {
      const sheetRow = parseInt(rowIndex) + 2;
      sheet.getRange(sheetRow, 1, 1, dataArray.length).setValues([dataArray]);
      return "Data Berhasil Diperbarui!";
    } else {
      sheet.appendRow(dataArray);
      return "Data Berhasil Ditambahkan!";
    }
  } catch (e) { return "Error: " + e.toString(); }
}

function deleteMasterData(dbId, sheetName, rowIndex) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, sheetName);
    const sheetRow = parseInt(rowIndex) + 2;
    sheet.deleteRow(sheetRow);
    return "Data Berhasil Dihapus!";
  } catch (e) { return "Error: " + e.toString(); }
}

function getDropdownData(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sToko = ensureSheetExists(ss, "Data_Toko");
    const sUraian = ensureSheetExists(ss, "Data_Uraian");
    const dataToko = sToko.getLastRow() > 1 ? sToko.getRange(2, 1, sToko.getLastRow()-1, 1).getValues().flat() : [];
    const dataUraian = sUraian.getLastRow() > 1 ? sUraian.getRange(2, 2, sUraian.getLastRow()-1, 1).getValues().flat() : [];
    return { toko: dataToko, uraian: dataUraian };
  } catch (e) { return { toko: [], uraian: [] }; }
}

function processTransaksiLengkap(dbId, header, items) {
  const ss = SpreadsheetApp.openById(dbId).getSheetByName("Transaksi");
  const idTrx = "TRX-" + new Date().getTime(); 
  let rowsToSave = [];
  items.forEach(item => {
    rowsToSave.push([idTrx, header.tanggal, header.uraian, header.toko, item.nama, item.vol, item.sat, item.harga, item.total, header.no_bukti]);
  });
  if (rowsToSave.length > 0) ss.getRange(ss.getLastRow() + 1, 1, rowsToSave.length, rowsToSave[0].length).setValues(rowsToSave);
  return "Transaksi Berhasil Disimpan!";
}

function getDashboardStats(dbId) {
  const ss = SpreadsheetApp.openById(dbId).getSheetByName("Transaksi");
  const lr = ss.getLastRow();
  if (lr <= 1) return { total: 0, count: 0 };
  const values = ss.getRange(2, 9, lr-1, 1).getValues(); 
  let totalBelanja = 0;
  values.forEach(v => totalBelanja += Number(v[0] || 0));
  return { total: totalBelanja, count: lr-1 };
}

// --- FUNGSI BARU: AMBIL RIWAYAT TRANSAKSI ---
function getRiwayatTransaksi(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId).getSheetByName("Transaksi");
    const lr = ss.getLastRow();
    
    if (lr <= 1) return [];
    
    // Ambil 50 baris terakhir saja
    const startRow = Math.max(2, lr - 49);
    const numRows = lr - startRow + 1;
    
    const data = ss.getRange(startRow, 1, numRows, 9).getValues();
    
    // Reverse agar yang terbaru di atas & format tanggal
    return data.reverse().map(row => {
      let tgl = "";
      if (row[1] && typeof row[1].getMonth === 'function') {
        tgl = Utilities.formatDate(row[1], Session.getScriptTimeZone(), "dd/MM/yyyy");
      }
      return {
        tanggal: tgl,
        uraian: row[2],
        toko: row[3],
        barang: row[4],
        total: row[8]
      };
    });
  } catch (e) {
    return [];
  }
}
