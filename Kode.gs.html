const ID_DB_MASTER = "1e1V7DQjOWRnx9KETszXwYYDCKAMeUfI3z9In9fM1fxM"; 
const ID_TEMPLATE = "126RPw6wPoUmPgYt16jyzd1EY-ma5xGFr8WoRSQoShUw"; 

function doGet(e) {
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setTitle('Sistem LPJ BOS Terpadu')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

// --- FUNGSI BANTUAN ---
function ensureSheetExists(ss, sheetName) {
  let sheet = ss.getSheetByName(sheetName);
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    if (sheetName === "Data_Toko") {
      sheet.appendRow(["Nama Toko", "Jenis Toko", "Alamat Toko", "No. Telp", "Pemilik", "Tanggal TTD"]);
    } else if (sheetName === "Data_Uraian") {
      sheet.appendRow(["Kode Rekening", "Nama Uraian Belanja"]);
    } else if (sheetName === "Data_Tukang") {
      sheet.appendRow(["Nama Tukang", "Alamat Tukang"]);
    }
    sheet.getRange(1, 1, 1, sheet.getLastColumn()).setFontWeight("bold");
  }
  return sheet;
}

// --- AUTH ---
function registerUser(form) {
  const ssMaster = SpreadsheetApp.openById(ID_DB_MASTER).getSheetByName("Users");
  const data = ssMaster.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][2] == form.email) return { status: "error", message: "Email sudah terdaftar!" };
  }
  try {
    const templateFile = DriveApp.getFileById(ID_TEMPLATE);
    const newFile = templateFile.makeCopy("DB BOS - " + form.sekolah);
    newFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.EDITOR);
    ssMaster.appendRow([new Date(), form.sekolah, form.email, form.password, newFile.getId()]);
    return { status: "success", message: "Registrasi Berhasil! Silakan Login." };
  } catch (e) {
    return { status: "error", message: "Gagal membuat database: " + e.toString() };
  }
}

function loginUser(form) {
  const ssMaster = SpreadsheetApp.openById(ID_DB_MASTER).getSheetByName("Users");
  const data = ssMaster.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][2] == form.email && data[i][3] == form.password) {
      return { status: "success", token: data[i][4], sekolah: data[i][1] }; 
    }
  }
  return { status: "error", message: "Email atau Password salah!" };
}

// --- DATA HANDLERS ---
function getDataSekolah(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId).getSheetByName("Data_Sekolah");
    const data = ss.getDataRange().getValues();
    let result = {};
    data.forEach(row => { if(row[0]) result[row[0]] = row[1]; });
    return result;
  } catch(e) { return {}; }
}

function saveDataSekolah(dbId, formObj) {
  const ss = SpreadsheetApp.openById(dbId).getSheetByName("Data_Sekolah");
  ss.clear(); 
  const entries = Object.entries(formObj);
  if(entries.length > 0) ss.getRange(1, 1, entries.length, 2).setValues(entries);
  return "Data Sekolah Berhasil Disimpan!";
}

function getAllMasterData(dbId, sheetName) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, sheetName);
    const lr = sheet.getLastRow();
    if (lr <= 1) return [];
    
    let data = sheet.getRange(2, 1, lr - 1, sheet.getLastColumn()).getValues();
    
    // Format Tanggal
    data = data.map(row => {
      return row.map(cell => {
        if (Object.prototype.toString.call(cell) === '[object Date]') {
          try { return cell.toISOString().split('T')[0]; } catch (e) { return ""; }
        }
        return cell;
      });
    });

    return data; 
  } catch (e) { return []; }
}

function saveMasterData(dbId, sheetName, dataArray, rowIndex) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, sheetName);
    if (rowIndex !== "" && rowIndex !== null && rowIndex !== undefined) {
      const sheetRow = parseInt(rowIndex) + 2;
      sheet.getRange(sheetRow, 1, 1, dataArray.length).setValues([dataArray]);
      return "Data Berhasil Diperbarui!";
    } else {
      sheet.appendRow(dataArray);
      return "Data Berhasil Ditambahkan!";
    }
  } catch (e) { return "Error: " + e.toString(); }
}

function deleteMasterData(dbId, sheetName, rowIndex) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, sheetName);
    const sheetRow = parseInt(rowIndex) + 2;
    sheet.deleteRow(sheetRow);
    return "Data Berhasil Dihapus!";
  } catch (e) { return "Error: " + e.toString(); }
}

function getDropdownData(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sToko = ensureSheetExists(ss, "Data_Toko");
    const sUraian = ensureSheetExists(ss, "Data_Uraian");
    const sTukang = ensureSheetExists(ss, "Data_Tukang"); // UPDATE: Ambil sheet Tukang

    const dataToko = sToko.getLastRow() > 1 ? sToko.getRange(2, 1, sToko.getLastRow()-1, 1).getValues().flat() : [];
    const dataUraian = sUraian.getLastRow() > 1 ? sUraian.getRange(2, 2, sUraian.getLastRow()-1, 1).getValues().flat() : [];
    const dataTukang = sTukang.getLastRow() > 1 ? sTukang.getRange(2, 1, sTukang.getLastRow()-1, 1).getValues().flat() : []; // UPDATE: Ambil data Tukang

    // UPDATE: Return dataTukang juga
    return { toko: dataToko, uraian: dataUraian, tukang: dataTukang }; 
  } catch (e) { return { toko: [], uraian: [], tukang: [] }; }
}

function processTransaksiLengkap(dbId, header, items) {
  const ss = SpreadsheetApp.openById(dbId).getSheetByName("Transaksi");
  const idTrx = "TRX-" + new Date().getTime(); 
  let rowsToSave = [];
  items.forEach(item => {
    rowsToSave.push([idTrx, header.tanggal, header.uraian, header.toko, item.nama, item.vol, item.sat, item.harga, item.total, header.no_bukti]);
  });
  if (rowsToSave.length > 0) ss.getRange(ss.getLastRow() + 1, 1, rowsToSave.length, rowsToSave[0].length).setValues(rowsToSave);
  return "Transaksi Berhasil Disimpan!";
}

function getDashboardStats(dbId) {
  const ss = SpreadsheetApp.openById(dbId);
  
  // 1. Ambil Total Anggaran dari Data_Sekolah
  let totalAnggaran = 0;
  try {
    const sSekolah = ss.getSheetByName("Data_Sekolah");
    if (sSekolah) {
      const dataSekolah = sSekolah.getDataRange().getValues();
      const rowAnggaran = dataSekolah.find(r => r[0] === 'total_anggaran');
      if (rowAnggaran) totalAnggaran = Number(rowAnggaran[1] || 0);
    }
  } catch(e) {}

  // 2. Hitung Transaksi
  const sTrx = ss.getSheetByName("Transaksi");
  const lr = sTrx.getLastRow();
  
  let totalBelanja = 0;
  let uniqueIds = new Set(); 
  
  if (lr > 1) {
    const values = sTrx.getRange(2, 1, lr - 1, 9).getValues(); 
    
    values.forEach(v => {
      const id = v[0];     
      const total = Number(v[8] || 0); 
      
      if(id) uniqueIds.add(id); 
      totalBelanja += total;
    });
  }
  
  const sisa = totalAnggaran - totalBelanja;

  return {
    anggaran: totalAnggaran,
    belanja: totalBelanja,
    sisa: sisa,
    count: uniqueIds.size 
  };
}

function getRiwayatTransaksiGrouped(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId).getSheetByName("Transaksi");
    const lr = ss.getLastRow();
    if (lr <= 1) return [];

    const data = ss.getRange(2, 1, lr - 1, 10).getValues(); 
    
    let grouped = {};
    
    for(let i = data.length - 1; i >= 0; i--) {
        let row = data[i];
        let id = row[0];
        
        if(!grouped[id]) {
            let tgl = "";
            if (row[1] && typeof row[1].getMonth === 'function') {
                tgl = Utilities.formatDate(row[1], Session.getScriptTimeZone(), "yyyy-MM-dd");
            }
            
            grouped[id] = {
                id: id,
                tanggal: tgl,
                uraian: row[2],
                toko: row[3],
                no_bukti: row[9],
                items: [],
                total_trx: 0
            };
        }
        
        grouped[id].items.push({
            nama: row[4],
            vol: row[5],
            sat: row[6],
            harga: row[7],
            total: row[8]
        });
        
        grouped[id].total_trx += Number(row[8] || 0);
    }
    return Object.values(grouped);
  } catch (e) {
    return [];
  }
}

function deleteTransaksiById(dbId, idTrx) {
    const ss = SpreadsheetApp.openById(dbId).getSheetByName("Transaksi");
    const data = ss.getDataRange().getValues();
    let deletedCount = 0;
    
    for (let i = data.length - 1; i >= 1; i--) {
        if (data[i][0] == idTrx) {
            ss.deleteRow(i + 1);
            deletedCount++;
        }
    }
    return "Berhasil menghapus transaksi.";
}
