const ID_DB_MASTER = "1e1V7DQjOWRnx9KETszXwYYDCKAMeUfI3z9In9fM1fxM"; // Ganti dengan ID Spreadsheet Master Anda jika berbeda
const ID_TEMPLATE = "126RPw6wPoUmPgYt16jyzd1EY-ma5xGFr8WoRSQoShUw"; // Ganti dengan ID Template Spreadsheet Anda

function doGet(e) {
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setTitle('Sistem LPJ BOS Terpadu')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

// --- FUNGSI BANTUAN ---
function ensureSheetExists(ss, sheetName) {
  let sheet = ss.getSheetByName(sheetName);
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    // Header Default untuk Sheet Baru
    if (sheetName === "Data_Toko") {
      // GANTI HEADER "Tanggal TTD" MENJADI "Tempat TTD"
      sheet.appendRow(["Nama Toko", "Jenis Toko", "Alamat Toko", "No. Telp", "Pemilik", "Tempat TTD"]);
    } else if (sheetName === "Data_Uraian") {
      sheet.appendRow(["Kode Rekening", "Nama Uraian Belanja"]);
    } else if (sheetName === "Data_Tukang") {
      sheet.appendRow(["Nama Tukang", "Alamat Tukang"]);
    } else if (sheetName === "Data_Nomor_Surat") {
      sheet.appendRow(["ID_TRX", "No_Keluar", "No_Masuk", "No_Periksa", "No_Terima", "No_Bayar"]);
    } else if (sheetName === "Data_Tanggal_Surat") {
      sheet.appendRow(["ID_TRX", "Tgl_Masuk", "Tgl_Periksa", "Tgl_Terima", "Tgl_Bayar"]);
    }
    sheet.getRange(1, 1, 1, sheet.getLastColumn()).setFontWeight("bold");
  }
  return sheet;
}

// --- AUTHENTICATION ---
function registerUser(form) {
  const ssMaster = SpreadsheetApp.openById(ID_DB_MASTER).getSheetByName("Users");
  const data = ssMaster.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][2] == form.email) return { status: "error", message: "Email sudah terdaftar!" };
  }
  try {
    const templateFile = DriveApp.getFileById(ID_TEMPLATE);
    const newFile = templateFile.makeCopy("DB BOS - " + form.sekolah);
    newFile.addEditor(form.email);
    ssMaster.appendRow([new Date(), form.sekolah, form.email, form.password, newFile.getId()]);
    return { status: "success", message: "Registrasi Berhasil! Silakan Login." };
  } catch (e) {
    return { status: "error", message: "Gagal membuat database: " + e.toString() };
  }
}

// --- OTP & REGISTRASI BARU ---

// 1. Fungsi Mengirim OTP ke Email
function sendOtpRegistration(email) {
  const ssMaster = SpreadsheetApp.openById(ID_DB_MASTER).getSheetByName("Users");
  const data = ssMaster.getDataRange().getValues();
  
  // Cek apakah email sudah terdaftar
  // Perhatikan: Karena struktur berubah, kita harus pastikan index email dicek dengan benar nanti.
  // Tapi untuk saat ini kita cek loop manual. 
  // Jika struktur LAMA: Email index 2. Jika BARU: Email index 3.
  // Untuk aman, kita asumsikan User belum mengubah sheet, jadi kita cek dua-duanya atau pakai find.
  
  for (let i = 1; i < data.length; i++) {
    // Cek index 2 (lama) atau 3 (baru)
    if (data[i][2] == email || data[i][3] == email) {
        return { status: "error", message: "Email sudah terdaftar!" };
    }
  }

  // Generate 6 Digit Code
  const otp = Math.floor(100000 + Math.random() * 900000).toString();
  
  // Simpan OTP di Script Properties (Berlaku global untuk script ini)
  // Format Key: "OTP_emailuser@gmail.com"
  const props = PropertiesService.getScriptProperties();
  props.setProperty("OTP_" + email, otp);
  
  // Kirim Email
  try {
    MailApp.sendEmail({
      to: email,
      subject: "Kode Verifikasi - Sistem LPJ BOS",
      htmlBody: `
        <h3>Verifikasi Email Pendaftaran</h3>
        <p>Halo,</p>
        <p>Berikut adalah kode verifikasi (OTP) untuk pendaftaran akun LPJ BOS Anda:</p>
        <h2 style="color:blue;">${otp}</h2>
        <p>Kode ini berlaku untuk sementara. Jangan berikan kepada siapapun.</p>
        <br>
        <small>Sistem LPJ BOS Terpadu</small>
      `
    });
    return { status: "success", message: "Kode OTP telah dikirim ke " + email };
  } catch (e) {
    return { status: "error", message: "Gagal mengirim email: " + e.toString() };
  }
}

function registerUserVerified(form) {
  const email = form.email;
  const inputOtp = form.otp_code;
  
  const props = PropertiesService.getScriptProperties();
  const storedOtp = props.getProperty("OTP_" + email);
  
  // 1. Validasi OTP
  if (!storedOtp) return { status: "error", message: "Kode OTP kadaluarsa atau belum diminta." };
  if (storedOtp !== inputOtp) return { status: "error", message: "Kode OTP Salah!" };
  
  props.deleteProperty("OTP_" + email);
  
  try {
    const ssMaster = SpreadsheetApp.openById(ID_DB_MASTER).getSheetByName("Users");
    
    // 2. Copy Template
    const templateFile = DriveApp.getFileById(ID_TEMPLATE);
    const newFile = templateFile.makeCopy("DB BOS - " + form.sekolah);
    const newDbId = newFile.getId();
    
    // === PERBAIKAN: TRY-CATCH UNTUK IZIN ===
    // Mencoba memberi akses edit, tapi jika gagal (misal email bukan Google),
    // proses TIDAK akan berhenti/error. Database tetap jadi.
    try {
      newFile.addEditor(form.email);
    } catch (permErr) {
      console.log("Peringatan Izin: " + permErr.toString());
      // Lanjut saja, jangan throw error
    }
    // ========================================

    // 3. Inject Data Sekolah
    try {
      const ssUser = SpreadsheetApp.openById(newDbId);
      let sheetSekolah = ssUser.getSheetByName("Data_Sekolah");
      if (!sheetSekolah) sheetSekolah = ssUser.insertSheet("Data_Sekolah");
      
      const existingData = sheetSekolah.getDataRange().getValues();
      let dataMap = {};
      existingData.forEach(row => { if(row[0]) dataMap[row[0]] = row[1]; });
      
      dataMap['sekolah'] = form.sekolah;
      dataMap['npsn']    = "'" + form.npsn;
      
      const finalData = Object.entries(dataMap);
      sheetSekolah.clear();
      if(finalData.length > 0) sheetSekolah.getRange(1, 1, finalData.length, 2).setValues(finalData);
    } catch (err) {
      console.error("Gagal inject Data Sekolah: " + err.toString());
    }

    // 4. Simpan ke Master
    ssMaster.appendRow([
      new Date(), 
      "'" + form.npsn, 
      form.sekolah, 
      form.email, 
      form.password, 
      newDbId
    ]);
    
    return { status: "success", message: "Registrasi Berhasil! Silakan Login." };
    
  } catch (e) {
    return { status: "error", message: "Gagal membuat database: " + e.toString() };
  }
}

// --- UPDATE FUNGSI LOGIN (PENTING!) ---
// Karena kita menambah kolom NPSN di urutan ke-2 (index 1), maka kolom setelahnya bergeser.
function loginUser(form) {
  const ssMaster = SpreadsheetApp.openById(ID_DB_MASTER).getSheetByName("Users");
  const data = ssMaster.getDataRange().getValues();
  
  // Asumsi Struktur Kolom: 
  // 0: Date, 1: NPSN, 2: Sekolah, 3: Email, 4: Password, 5: Token/FileId
  
  for (let i = 1; i < data.length; i++) {
    // Cek Email (Kolom Index 3) & Password (Kolom Index 4)
    // KITA PAKAI LOGIKA GANDA UNTUK MENGANTISIPASI DATA LAMA vs BARU
    
    // Cek Format Baru (Ada NPSN) - Jika kolom terakhir ada di index 5
    if (data[i].length >= 6) { 
       if (data[i][3] == form.email && data[i][4] == form.password) {
         return { status: "success", token: data[i][5], sekolah: data[i][2] }; 
       }
    }
    
    // Fallback: Cek Format Lama (Tanpa NPSN) - Jika kolomnya cuma 5
    // 0: Date, 1: Sekolah, 2: Email, 3: Password, 4: Token
    if (data[i][2] == form.email && data[i][3] == form.password) {
       return { status: "success", token: data[i][4], sekolah: data[i][1] }; 
    }
  }
  
  return { status: "error", message: "Email atau Password salah!" };
}

// --- DATA SEKOLAH ---
function getDataSekolah(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId).getSheetByName("Data_Sekolah");
    if(!ss) return {};
    const data = ss.getDataRange().getValues();
    let result = {};
    data.forEach(row => { if(row[0]) result[row[0]] = row[1]; });
    return result;
  } catch(e) { return {}; }
}

function saveDataSekolah(dbId, formObj) {
  const ss = SpreadsheetApp.openById(dbId).getSheetByName("Data_Sekolah");
  const existingData = ss.getDataRange().getValues();
  let dataMap = {};
  existingData.forEach(row => { if(row[0]) dataMap[row[0]] = row[1]; });
  
  Object.keys(formObj).forEach(key => { dataMap[key] = formObj[key]; });
  
  const finalData = Object.entries(dataMap);
  ss.clear(); 
  if(finalData.length > 0) ss.getRange(1, 1, finalData.length, 2).setValues(finalData);
  return "Data Sekolah Berhasil Disimpan!";
}

function updateDataSekolahKey(dbId, key, value) {
  const ss = SpreadsheetApp.openById(dbId).getSheetByName("Data_Sekolah");
  const data = ss.getDataRange().getValues();
  let dataMap = {};
  data.forEach(row => { if(row[0]) dataMap[row[0]] = row[1]; });
  dataMap[key] = value;
  const finalData = Object.entries(dataMap);
  ss.clear();
  if(finalData.length > 0) ss.getRange(1, 1, finalData.length, 2).setValues(finalData);
}

// --- DATA MASTER ---
function getAllMasterData(dbId, sheetName) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, sheetName);
    const lr = sheet.getLastRow();
    if (lr <= 1) return [];
    
    let data = sheet.getRange(2, 1, lr - 1, sheet.getLastColumn()).getValues();
    // Format Tanggal ISO
    data = data.map(row => {
      return row.map(cell => {
        if (Object.prototype.toString.call(cell) === '[object Date]') {
          try { return cell.toISOString().split('T')[0]; } catch (e) { return ""; }
        }
        return cell;
      });
    });
    return data; 
  } catch (e) { return []; }
}

function saveMasterData(dbId, sheetName, dataArray, rowIndex) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, sheetName);
    if (rowIndex !== "" && rowIndex !== null && rowIndex !== undefined) {
      const sheetRow = parseInt(rowIndex) + 2;
      sheet.getRange(sheetRow, 1, 1, dataArray.length).setValues([dataArray]);
      return "Data Berhasil Diperbarui!";
    } else {
      sheet.appendRow(dataArray);
      return "Data Berhasil Ditambahkan!";
    }
  } catch (e) { return "Error: " + e.toString(); }
}

function deleteMasterData(dbId, sheetName, rowIndex) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, sheetName);
    const sheetRow = parseInt(rowIndex) + 2;
    sheet.deleteRow(sheetRow);
    return "Data Berhasil Dihapus!";
  } catch (e) { return "Error: " + e.toString(); }
}

function getDropdownData(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sToko = ensureSheetExists(ss, "Data_Toko");
    const sUraian = ensureSheetExists(ss, "Data_Uraian");
    const sTukang = ensureSheetExists(ss, "Data_Tukang");

    const dataToko = sToko.getLastRow() > 1 ? sToko.getRange(2, 1, sToko.getLastRow()-1, 1).getValues().flat() : [];
    const dataUraian = sUraian.getLastRow() > 1 ? sUraian.getRange(2, 2, sUraian.getLastRow()-1, 1).getValues().flat() : [];
    const dataTukang = sTukang.getLastRow() > 1 ? sTukang.getRange(2, 1, sTukang.getLastRow()-1, 1).getValues().flat() : [];

    return { toko: dataToko, uraian: dataUraian, tukang: dataTukang }; 
  } catch (e) { return { toko: [], uraian: [], tukang: [] }; }
}

// --- TRANSAKSI (LOGIKA UTAMA) ---

// Fungsi ini menangani Simpan Baru dan Update (Edit)
function processTransaksiLengkap(dbId, header, items, idEdit) {
  const ss = SpreadsheetApp.openById(dbId).getSheetByName("Transaksi");
  let idTrx;

  // 1. Cek apakah ini mode EDIT (Update)
  if (idEdit && idEdit !== "") {
    idTrx = idEdit; // Gunakan ID lama agar relasi ke tabel lain (Nomor Surat) tidak putus
    
    // Hapus data lama yang punya ID ini
    const data = ss.getDataRange().getValues();
    // Loop mundur untuk aman saat delete row
    for (let i = data.length - 1; i >= 1; i--) {
      if (data[i][0] == idEdit) {
        ss.deleteRow(i + 1);
      }
    }
  } else {
    // 2. Jika mode BARU (Create), generate ID baru
    idTrx = "TRX-" + new Date().getTime(); 
  }

  // 3. Susun data baru
  let rowsToSave = [];
  items.forEach(item => {
    rowsToSave.push([
      idTrx, 
      header.tanggal, 
      header.uraian, 
      header.toko, 
      item.nama, 
      item.vol, 
      item.sat, 
      item.harga, 
      item.total, 
      header.no_bukti
    ]);
  });

  // 4. Simpan ke sheet
  if (rowsToSave.length > 0) {
    ss.getRange(ss.getLastRow() + 1, 1, rowsToSave.length, rowsToSave[0].length).setValues(rowsToSave);
  }

  return idEdit ? "Transaksi Berhasil Diperbarui!" : "Transaksi Berhasil Disimpan!";
}

function getDashboardStats(dbId) {
  const ss = SpreadsheetApp.openById(dbId);
  
  let totalAnggaran = 0;
  try {
    const sSekolah = ss.getSheetByName("Data_Sekolah");
    if (sSekolah) {
      const dataSekolah = sSekolah.getDataRange().getValues();
      const rowAnggaran = dataSekolah.find(r => r[0] === 'total_anggaran');
      if (rowAnggaran) totalAnggaran = Number(rowAnggaran[1] || 0);
    }
  } catch(e) {}

  const sTrx = ss.getSheetByName("Transaksi");
  let totalBelanja = 0;
  let uniqueIds = new Set(); 
  
  if (sTrx && sTrx.getLastRow() > 1) {
    const values = sTrx.getRange(2, 1, sTrx.getLastRow() - 1, 9).getValues(); 
    values.forEach(v => {
      if(v[0]) uniqueIds.add(v[0]); 
      totalBelanja += Number(v[8] || 0);
    });
  }
  
  return {
    anggaran: totalAnggaran,
    belanja: totalBelanja,
    sisa: totalAnggaran - totalBelanja,
    count: uniqueIds.size 
  };
}

function getRiwayatTransaksiGrouped(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId).getSheetByName("Transaksi");
    const lr = ss.getLastRow();
    if (lr <= 1) return [];

    const data = ss.getRange(2, 1, lr - 1, 10).getValues(); 
    let grouped = {};
    
    for(let i = data.length - 1; i >= 0; i--) {
        let row = data[i];
        let id = row[0];
        
        if(!grouped[id]) {
            let tgl = "";
            if (row[1] && typeof row[1].getMonth === 'function') {
                tgl = Utilities.formatDate(row[1], Session.getScriptTimeZone(), "yyyy-MM-dd");
            }
            grouped[id] = {
                id: id,
                tanggal: tgl,
                uraian: row[2],
                toko: row[3],
                no_bukti: row[9],
                items: [],
                total_trx: 0
            };
        }
        
        grouped[id].items.push({
            nama: row[4],
            vol: row[5],
            sat: row[6],
            harga: row[7],
            total: row[8]
        });
        grouped[id].total_trx += Number(row[8] || 0);
    }
    return Object.values(grouped);
  } catch (e) { return []; }
}

function deleteTransaksiById(dbId, idTrx) {
    const ss = SpreadsheetApp.openById(dbId).getSheetByName("Transaksi");
    const data = ss.getDataRange().getValues();
    for (let i = data.length - 1; i >= 1; i--) {
        if (data[i][0] == idTrx) ss.deleteRow(i + 1);
    }
    return "Berhasil menghapus transaksi.";
}

// --- PENGATURAN CETAK (KOP, NOMOR, TANGGAL) ---

// 1. Kop Surat
function saveKopSuratToDrive(dbId, base64Data, mimeType, sekolahName) {
  try {
    const folderName = "LPJ_Attachments";
    const fileName = "KopSurat_" + sekolahName + "_" + new Date().getTime();
    
    const folders = DriveApp.getFoldersByName(folderName);
    let folder = folders.hasNext() ? folders.next() : DriveApp.createFolder(folderName);
    
    const blob = Utilities.newBlob(Utilities.base64Decode(base64Data), mimeType, fileName);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    updateDataSekolahKey(dbId, "id_kop_surat", file.getId());
    return { status: "success", url: "data:" + mimeType + ";base64," + base64Data };
  } catch (e) {
    return { status: "error", message: e.toString() };
  }
}

function getKopSuratUrl(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId).getSheetByName("Data_Sekolah");
    if (!ss) return null;
    const data = ss.getDataRange().getValues();
    const row = data.find(r => r[0] === "id_kop_surat");
    const fileId = row ? row[1] : null; 
    
    if (fileId) {
      const file = DriveApp.getFileById(fileId);
      const blob = file.getBlob();
      return "data:" + blob.getContentType() + ";base64," + Utilities.base64Encode(blob.getBytes());
    }
    return null;
  } catch(e) { return null; }
}

// 2. Nomor Surat
function getNomorSuratData(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, "Data_Nomor_Surat");
    const data = sheet.getDataRange().getValues();
    let map = {};
    for(let i=1; i<data.length; i++) {
      map[data[i][0]] = { keluar: data[i][1], masuk: data[i][2], periksa: data[i][3], terima: data[i][4], bayar: data[i][5] };
    }
    return map;
  } catch (e) { return {}; }
}

function saveNomorSuratData(dbId, formData) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, "Data_Nomor_Surat");
    const data = sheet.getDataRange().getValues();
    let rowIndex = -1;
    for(let i=1; i<data.length; i++) {
      if(data[i][0] == formData.id_trx) { rowIndex = i + 1; break; }
    }
    const rowData = [formData.id_trx, formData.no_keluar, formData.no_masuk, formData.no_periksa, formData.no_terima, formData.no_bayar];
    if (rowIndex > 0) sheet.getRange(rowIndex, 1, 1, 6).setValues([rowData]);
    else sheet.appendRow(rowData);
    return "Nomor Surat Berhasil Disimpan!";
  } catch (e) { return "Error: " + e.toString(); }
}

// 3. Tanggal Surat
function getTanggalSuratData(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, "Data_Tanggal_Surat");
    const data = sheet.getDataRange().getValues();
    let map = {};
    const toYMD = (dateObj) => {
      if (!dateObj || dateObj === "") return "";
      try { return Utilities.formatDate(new Date(dateObj), Session.getScriptTimeZone(), "yyyy-MM-dd"); } catch (e) { return ""; }
    };
    for(let i=1; i<data.length; i++) {
      map[data[i][0]] = { masuk: toYMD(data[i][1]), periksa: toYMD(data[i][2]), terima: toYMD(data[i][3]), bayar: toYMD(data[i][4]) };
    }
    return map;
  } catch (e) { return {}; }
}

function saveTanggalSuratData(dbId, formData) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, "Data_Tanggal_Surat");
    const data = sheet.getDataRange().getValues();
    let rowIndex = -1;
    for(let i=1; i<data.length; i++) {
      if(data[i][0] == formData.id_trx) { rowIndex = i + 1; break; }
    }
    const rowData = [formData.id_trx, formData.tgl_masuk, formData.tgl_periksa, formData.tgl_terima, formData.tgl_bayar];
    if (rowIndex > 0) sheet.getRange(rowIndex, 1, 1, 5).setValues([rowData]);
    else sheet.appendRow(rowData);
    return "Data Tanggal Berhasil Disimpan!";
  } catch (e) { return "Error: " + e.toString(); }
}

// ==========================================
// FITUR CETAK PDF
// ==========================================

function terbilang(nilai) {
  var bilangan = String(nilai);
  var angka = new Array('0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0');
  var kata = new Array('', 'Satu', 'Dua', 'Tiga', 'Empat', 'Lima', 'Enam', 'Tujuh', 'Delapan', 'Sembilan');
  var tingkat = new Array('', 'Ribu', 'Juta', 'Milyar', 'Trilyun');
  var panjang_bilangan = bilangan.length;

  /* pengujian panjang bilangan */
  if (panjang_bilangan > 15) {
    return "Diluar Batas";
  }

  /* mengambil angka-angka yang ada dalam bilangan, dimasukkan ke dalam array */
  for (var i = 1; i <= panjang_bilangan; i++) {
    angka[i] = bilangan.substr(-(i), 1);
  }

  var i = 1;
  var j = 0;
  var kalimat = "";

  /* mulai proses iterasi terhadap array angka */
  while (i <= panjang_bilangan) {
    var subkalimat = "";
    var kata1 = "";
    var kata2 = "";
    var kata3 = "";

    /* untuk Ratusan */
    if (angka[i + 2] != "0") {
      if (angka[i + 2] == "1") {
        kata1 = "Seratus";
      } else {
        kata1 = kata[angka[i + 2]] + " Ratus";
      }
    }

    /* untuk Puluhan atau Belasan */
    if (angka[i + 1] != "0") {
      if (angka[i + 1] == "1") {
        if (angka[i] == "0") {
          kata2 = "Sepuluh";
        } else if (angka[i] == "1") {
          kata2 = "Sebelas";
        } else {
          kata2 = kata[angka[i]] + " Belas";
        }
      } else {
        kata2 = kata[angka[i + 1]] + " Puluh";
      }
    }

    /* untuk Satuan */
    if (angka[i] != "0") {
      if (angka[i + 1] != "1") {
        kata3 = kata[angka[i]];
      }
    }

    /* pengujian angka apakah tidak nol semua, lalu ditambahkan tingkat */
    if ((angka[i] != "0") || (angka[i + 1] != "0") || (angka[i + 2] != "0")) {
      subkalimat = kata1 + " " + kata2 + " " + kata3 + " " + tingkat[j] + " ";
    }

    /* gabungkan variabe sub kalimat (untuk Satu blok 3 angka) ke variabel kalimat */
    kalimat = subkalimat + kalimat;
    i = i + 3;
    j = j + 1;
  }

  /* mengganti Satu Ribu jadi Seribu jika diperlukan */
  if ((angka[5] == "0") && (angka[6] == "0")) {
    kalimat = kalimat.replace("Satu Ribu", "Seribu");
  }

  return kalimat.trim();
}

function generatePDFLaporan(dbId, idTrx) {
  try {
    // 1. Ambil Data Transaksi & Item
    const ss = SpreadsheetApp.openById(dbId);
    const dataTrxRaw = getRiwayatTransaksiGrouped(dbId);
    const trx = dataTrxRaw.find(t => t.id === idTrx);
    if (!trx) throw new Error("Transaksi tidak ditemukan");

    // 2. Ambil Data Sekolah & Kop
    const sekolah = getDataSekolah(dbId);
    const kopUrl = getKopSuratUrl(dbId); 
    sekolah.kop_base64 = kopUrl;
    
    sekolah.kota = "Kab. Bulukumba"; 
    if(sekolah.alamat && sekolah.alamat.includes("Kab.")) {
       sekolah.kota = sekolah.alamat.split("Kab.")[1].split(",")[0].trim();
       sekolah.kota = "Kab. " + sekolah.kota;
    }

    // 3. Ambil Data Pihak (Toko atau Tukang)
    let dataToko = {};
    const sToko = ss.getSheetByName("Data_Toko");
    
    if (sToko) {
      const vals = sToko.getRange(2, 1, sToko.getLastRow(), 6).getValues();
      const found = vals.find(r => r[0] == trx.toko);
      if (found) {
        dataToko = { 
          nama: found[0], 
          alamat: found[2], 
          telp: found[3], 
          pemilik: found[4], 
          kota: found[5] || sekolah.kota 
        };
      } else {
         const sTukang = ss.getSheetByName("Data_Tukang");
         if(sTukang) {
            const valsTk = sTukang.getRange(2, 1, sTukang.getLastRow(), 2).getValues();
            const foundTk = valsTk.find(r => r[0] == trx.toko);
            if(foundTk) {
              dataToko = { 
                nama: foundTk[0], 
                alamat: foundTk[1], 
                telp: "-", 
                pemilik: foundTk[0], 
                kota: sekolah.kota 
              };
            }
         }
      }
    }

    // 4. Ambil Data Nomor Surat & Tanggal Surat
    const mapNomor = getNomorSuratData(dbId);
    const mapTanggal = getTanggalSuratData(dbId);
    const dataNomor = mapNomor[idTrx] || {};
    const dataTanggal = mapTanggal[idTrx] || {};

    // 5. GABUNGKAN TEMPLATE HTML (PERBAIKAN DI SINI)
    // Gunakan .getRawContent() agar tag <? ?> terbaca sebagai kode, bukan teks.
    var htmlContentString = '<!DOCTYPE html><html><head>';
    
    // CSS boleh pakai createHtmlOutputFromFile karena isinya cuma style
    htmlContentString += HtmlService.createHtmlOutputFromFile('CetakCSS').getContent();
    htmlContentString += '</head><body>';
    
    // FILE HTML HARUS PAKAI createTemplateFromFile(...).getRawContent()
    htmlContentString += HtmlService.createTemplateFromFile('Cetak_1_Permintaan').getRawContent();
    htmlContentString += HtmlService.createTemplateFromFile('Cetak_2_Penawaran').getRawContent();
    htmlContentString += HtmlService.createTemplateFromFile('Cetak_3_Pemeriksaan').getRawContent();
    htmlContentString += HtmlService.createTemplateFromFile('Cetak_4_SerahTerima').getRawContent();
    htmlContentString += HtmlService.createTemplateFromFile('Cetak_5_Faktur').getRawContent();
    htmlContentString += HtmlService.createTemplateFromFile('Cetak_6_Pembayaran').getRawContent();
    htmlContentString += HtmlService.createTemplateFromFile('Cetak_7_Kwitansi').getRawContent();
    
    htmlContentString += '</body></html>';

    // 6. Buat Template Object dari String Gabungan tadi
    const template = HtmlService.createTemplate(htmlContentString);

    // 7. Inject Variabel Data
    template.trx = trx;
    template.items = trx.items;
    template.sekolah = sekolah;
    template.toko = dataToko;
    template.nomor = dataNomor;
    template.tanggal = dataTanggal;

    // 8. Definisi Fungsi Helper
    template.fmtRupiah = function(n) { 
      return "Rp " + new Intl.NumberFormat('id-ID').format(n); 
    };
    template.fmtDate = function(d) {
       if(!d) return "";
       return Utilities.formatDate(new Date(d), "GMT+8", "dd MMMM yyyy");
    };
    template.hari = function(d) {
      if(!d) return "";
      const days = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
      return days[new Date(d).getDay()];
    };
    template.terbilang = terbilang; 
    template.terbilangTanggal = function(d) {
       if(!d) return "";
       return Utilities.formatDate(new Date(d), "GMT+8", "dd MMMM yyyy");
    };

    // 9. Evaluasi Template
    const finalHtml = template.evaluate().getContent();
    
    // 10. Konversi ke PDF
    const blob = Utilities.newBlob(finalHtml, MimeType.HTML).setName("Laporan_" + idTrx + ".pdf");
    
    const folderName = "LPJ_Attachments";
    const folders = DriveApp.getFoldersByName(folderName);
    const folder = folders.hasNext() ? folders.next() : DriveApp.createFolder(folderName);
    
    const pdfName = "LPJ_" + trx.toko.replace(/[^a-zA-Z0-9 ]/g, "") + "_" + trx.tanggal + ".pdf";
    const filePDF = folder.createFile(blob.getAs(MimeType.PDF).setName(pdfName));
    
    filePDF.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    return { status: 'success', url: filePDF.getDownloadUrl().replace("&gd=true","") };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

function cekIzinEmail() {
  var sisa = MailApp.getRemainingDailyQuota();
  console.log("Sisa kuota email hari ini: " + sisa);
}
