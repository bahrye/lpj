const ID_DB_MASTER = "1e1V7DQjOWRnx9KETszXwYYDCKAMeUfI3z9In9fM1fxM"; 
const ID_TEMPLATE = "126RPw6wPoUmPgYt16jyzd1EY-ma5xGFr8WoRSQoShUw"; 

function doGet(e) {
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setTitle('Sistem LPJ BOS Terpadu')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

// --- FUNGSI BANTUAN ---
function ensureSheetExists(ss, sheetName) {
  let sheet = ss.getSheetByName(sheetName);
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    if (sheetName === "Data_Toko") {
      sheet.appendRow(["Nama Toko", "Jenis Toko", "Alamat Toko", "No. Telp", "Pemilik", "Tanggal TTD"]);
    } else if (sheetName === "Data_Uraian") {
      sheet.appendRow(["Kode Rekening", "Nama Uraian Belanja"]);
    } else if (sheetName === "Data_Tukang") {
      sheet.appendRow(["Nama Tukang", "Alamat Tukang"]);
    } else if (sheetName === "Data_Nomor_Surat") {
      sheet.appendRow(["ID_TRX", "No_Keluar", "No_Masuk", "No_Periksa", "No_Terima", "No_Bayar"]);
    }
    sheet.getRange(1, 1, 1, sheet.getLastColumn()).setFontWeight("bold");
  }
  return sheet;
}

// --- AUTH ---
function registerUser(form) {
  const ssMaster = SpreadsheetApp.openById(ID_DB_MASTER).getSheetByName("Users");
  const data = ssMaster.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][2] == form.email) return { status: "error", message: "Email sudah terdaftar!" };
  }
  try {
    const templateFile = DriveApp.getFileById(ID_TEMPLATE);
    const newFile = templateFile.makeCopy("DB BOS - " + form.sekolah);
    newFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.EDITOR);
    ssMaster.appendRow([new Date(), form.sekolah, form.email, form.password, newFile.getId()]);
    return { status: "success", message: "Registrasi Berhasil! Silakan Login." };
  } catch (e) {
    return { status: "error", message: "Gagal membuat database: " + e.toString() };
  }
}

function loginUser(form) {
  const ssMaster = SpreadsheetApp.openById(ID_DB_MASTER).getSheetByName("Users");
  const data = ssMaster.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][2] == form.email && data[i][3] == form.password) {
      return { status: "success", token: data[i][4], sekolah: data[i][1] }; 
    }
  }
  return { status: "error", message: "Email atau Password salah!" };
}

// --- DATA HANDLERS ---
function getDataSekolah(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId).getSheetByName("Data_Sekolah");
    if(!ss) return {};
    const data = ss.getDataRange().getValues();
    let result = {};
    data.forEach(row => { if(row[0]) result[row[0]] = row[1]; });
    return result;
  } catch(e) { return {}; }
}

// UPDATE: Menyimpan data sekolah tanpa menimpa key lain (seperti id_kop_surat)
function saveDataSekolah(dbId, formObj) {
  const ss = SpreadsheetApp.openById(dbId).getSheetByName("Data_Sekolah");
  
  // 1. Baca data lama agar key lain tidak hilang
  const existingData = ss.getDataRange().getValues();
  let dataMap = {};
  existingData.forEach(row => {
    if(row[0]) dataMap[row[0]] = row[1];
  });
  
  // 2. Update dengan data baru
  Object.keys(formObj).forEach(key => {
    dataMap[key] = formObj[key];
  });
  
  // 3. Tulis ulang
  const finalData = Object.entries(dataMap);
  ss.clear(); 
  if(finalData.length > 0) ss.getRange(1, 1, finalData.length, 2).setValues(finalData);
  return "Data Sekolah Berhasil Disimpan!";
}

// Fungsi helper untuk update satu key spesifik di Data_Sekolah
function updateDataSekolahKey(dbId, key, value) {
  const ss = SpreadsheetApp.openById(dbId).getSheetByName("Data_Sekolah");
  const data = ss.getDataRange().getValues();
  
  let dataMap = {};
  data.forEach(row => { if(row[0]) dataMap[row[0]] = row[1]; });
  
  dataMap[key] = value;
  
  const finalData = Object.entries(dataMap);
  ss.clear();
  if(finalData.length > 0) {
    ss.getRange(1, 1, finalData.length, 2).setValues(finalData);
  }
}

function getAllMasterData(dbId, sheetName) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, sheetName);
    const lr = sheet.getLastRow();
    if (lr <= 1) return [];
    
    let data = sheet.getRange(2, 1, lr - 1, sheet.getLastColumn()).getValues();
    
    // Format Tanggal
    data = data.map(row => {
      return row.map(cell => {
        if (Object.prototype.toString.call(cell) === '[object Date]') {
          try { return cell.toISOString().split('T')[0]; } catch (e) { return ""; }
        }
        return cell;
      });
    });

    return data; 
  } catch (e) { return []; }
}

function saveMasterData(dbId, sheetName, dataArray, rowIndex) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, sheetName);
    if (rowIndex !== "" && rowIndex !== null && rowIndex !== undefined) {
      const sheetRow = parseInt(rowIndex) + 2;
      sheet.getRange(sheetRow, 1, 1, dataArray.length).setValues([dataArray]);
      return "Data Berhasil Diperbarui!";
    } else {
      sheet.appendRow(dataArray);
      return "Data Berhasil Ditambahkan!";
    }
  } catch (e) { return "Error: " + e.toString(); }
}

function deleteMasterData(dbId, sheetName, rowIndex) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, sheetName);
    const sheetRow = parseInt(rowIndex) + 2;
    sheet.deleteRow(sheetRow);
    return "Data Berhasil Dihapus!";
  } catch (e) { return "Error: " + e.toString(); }
}

function getDropdownData(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sToko = ensureSheetExists(ss, "Data_Toko");
    const sUraian = ensureSheetExists(ss, "Data_Uraian");
    const sTukang = ensureSheetExists(ss, "Data_Tukang");

    const dataToko = sToko.getLastRow() > 1 ? sToko.getRange(2, 1, sToko.getLastRow()-1, 1).getValues().flat() : [];
    const dataUraian = sUraian.getLastRow() > 1 ? sUraian.getRange(2, 2, sUraian.getLastRow()-1, 1).getValues().flat() : [];
    const dataTukang = sTukang.getLastRow() > 1 ? sTukang.getRange(2, 1, sTukang.getLastRow()-1, 1).getValues().flat() : [];

    return { toko: dataToko, uraian: dataUraian, tukang: dataTukang }; 
  } catch (e) { return { toko: [], uraian: [], tukang: [] }; }
}

function processTransaksiLengkap(dbId, header, items) {
  const ss = SpreadsheetApp.openById(dbId).getSheetByName("Transaksi");
  const idTrx = "TRX-" + new Date().getTime(); 
  let rowsToSave = [];
  items.forEach(item => {
    rowsToSave.push([idTrx, header.tanggal, header.uraian, header.toko, item.nama, item.vol, item.sat, item.harga, item.total, header.no_bukti]);
  });
  if (rowsToSave.length > 0) ss.getRange(ss.getLastRow() + 1, 1, rowsToSave.length, rowsToSave[0].length).setValues(rowsToSave);
  return "Transaksi Berhasil Disimpan!";
}

function getDashboardStats(dbId) {
  const ss = SpreadsheetApp.openById(dbId);
  
  let totalAnggaran = 0;
  try {
    const sSekolah = ss.getSheetByName("Data_Sekolah");
    if (sSekolah) {
      const dataSekolah = sSekolah.getDataRange().getValues();
      const rowAnggaran = dataSekolah.find(r => r[0] === 'total_anggaran');
      if (rowAnggaran) totalAnggaran = Number(rowAnggaran[1] || 0);
    }
  } catch(e) {}

  const sTrx = ss.getSheetByName("Transaksi");
  let totalBelanja = 0;
  let uniqueIds = new Set(); 
  
  if (sTrx && sTrx.getLastRow() > 1) {
    const values = sTrx.getRange(2, 1, sTrx.getLastRow() - 1, 9).getValues(); 
    values.forEach(v => {
      if(v[0]) uniqueIds.add(v[0]); 
      totalBelanja += Number(v[8] || 0);
    });
  }
  
  return {
    anggaran: totalAnggaran,
    belanja: totalBelanja,
    sisa: totalAnggaran - totalBelanja,
    count: uniqueIds.size 
  };
}

function getRiwayatTransaksiGrouped(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId).getSheetByName("Transaksi");
    const lr = ss.getLastRow();
    if (lr <= 1) return [];

    const data = ss.getRange(2, 1, lr - 1, 10).getValues(); 
    let grouped = {};
    
    for(let i = data.length - 1; i >= 0; i--) {
        let row = data[i];
        let id = row[0];
        
        if(!grouped[id]) {
            let tgl = "";
            if (row[1] && typeof row[1].getMonth === 'function') {
                tgl = Utilities.formatDate(row[1], Session.getScriptTimeZone(), "yyyy-MM-dd");
            }
            
            grouped[id] = {
                id: id,
                tanggal: tgl,
                uraian: row[2],
                toko: row[3],
                no_bukti: row[9],
                items: [],
                total_trx: 0
            };
        }
        
        grouped[id].items.push({
            nama: row[4],
            vol: row[5],
            sat: row[6],
            harga: row[7],
            total: row[8]
        });
        grouped[id].total_trx += Number(row[8] || 0);
    }
    return Object.values(grouped);
  } catch (e) { return []; }
}

function deleteTransaksiById(dbId, idTrx) {
    const ss = SpreadsheetApp.openById(dbId).getSheetByName("Transaksi");
    const data = ss.getDataRange().getValues();
    for (let i = data.length - 1; i >= 1; i--) {
        if (data[i][0] == idTrx) ss.deleteRow(i + 1);
    }
    return "Berhasil menghapus transaksi.";
}

// --- FITUR PENGATURAN CETAK (BARU) ---

// 1. Upload Kop Surat (Simpan ID File ke Data_Sekolah)
function saveKopSuratToDrive(dbId, base64Data, mimeType, sekolahName) {
  try {
    const folderName = "LPJ_Attachments";
    const fileName = "KopSurat_" + sekolahName + "_" + new Date().getTime();
    
    const folders = DriveApp.getFoldersByName(folderName);
    let folder = folders.hasNext() ? folders.next() : DriveApp.createFolder(folderName);
    
    const blob = Utilities.newBlob(Utilities.base64Decode(base64Data), mimeType, fileName);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    updateDataSekolahKey(dbId, "id_kop_surat", file.getId());
    
    // UBAH RETURN VALUE:
    // Kembalikan Data URI agar frontend bisa langsung preview tanpa reload dari drive
    const returnData = "data:" + mimeType + ";base64," + base64Data;
    
    return { status: "success", url: returnData };
  } catch (e) {
    return { status: "error", message: e.toString() };
  }
}

// GANTI FUNGSI INI DI Kode.gs
function getKopSuratUrl(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId).getSheetByName("Data_Sekolah");
    if (!ss) return null;
    const data = ss.getDataRange().getValues();
    
    // Cari ID File
    const row = data.find(r => r[0] === "id_kop_surat");
    const fileId = row ? row[1] : null; 
    
    if (fileId) {
      // PERUBAHAN UTAMA: 
      // Ambil file fisik, konversi ke Base64, lalu kirim string datanya
      const file = DriveApp.getFileById(fileId);
      const blob = file.getBlob();
      const base64Data = Utilities.base64Encode(blob.getBytes());
      const contentType = blob.getContentType(); // misal: image/png
      
      // Return format Data URI
      return "data:" + contentType + ";base64," + base64Data;
    }
    return null;
  } catch(e) { 
    return null; // Return null jika error atau file terhapus
  }
}

// 2. Data Nomor Surat
function getNomorSuratData(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, "Data_Nomor_Surat");
    
    // Jika header belum ada
    if (sheet.getLastRow() === 0) {
        sheet.appendRow(["ID_TRX", "No_Keluar", "No_Masuk", "No_Periksa", "No_Terima", "No_Bayar"]);
    }
    
    const data = sheet.getDataRange().getValues();
    let map = {};
    for(let i=1; i<data.length; i++) {
      map[data[i][0]] = {
        keluar: data[i][1],
        masuk: data[i][2],
        periksa: data[i][3],
        terima: data[i][4],
        bayar: data[i][5]
      };
    }
    return map;
  } catch (e) { return {}; }
}

function saveNomorSuratData(dbId, formData) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, "Data_Nomor_Surat");
    const data = sheet.getDataRange().getValues();
    
    let rowIndex = -1;
    for(let i=1; i<data.length; i++) {
      if(data[i][0] == formData.id_trx) {
        rowIndex = i + 1; 
        break;
      }
    }
    
    const rowData = [
      formData.id_trx, 
      formData.no_keluar, 
      formData.no_masuk, 
      formData.no_periksa, 
      formData.no_terima, 
      formData.no_bayar
    ];
    
    if (rowIndex > 0) {
      sheet.getRange(rowIndex, 1, 1, 6).setValues([rowData]);
    } else {
      sheet.appendRow(rowData);
    }
    
    return "Nomor Surat Berhasil Disimpan!";
  } catch (e) { return "Error: " + e.toString(); }
}

// --- 3. Data Tanggal Surat (BARU) ---

function getTanggalSuratData(dbId) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    // Pastikan sheet ada. Headers: ID_TRX, Tgl_Masuk, Tgl_Periksa, Tgl_Terima, Tgl_Bayar
    const sheet = ensureSheetExists(ss, "Data_Tanggal_Surat"); 
    
    // Jika header belum ada (baris 1 kosong atau sheet baru)
    if (sheet.getLastRow() === 0) {
        sheet.appendRow(["ID_TRX", "Tgl_Masuk", "Tgl_Periksa", "Tgl_Terima", "Tgl_Bayar"]);
    }
    
    const data = sheet.getDataRange().getValues();
    let map = {};
    
    // Helper convert date object to YYYY-MM-DD for HTML input
    const toYMD = (dateObj) => {
      if (!dateObj || dateObj === "") return "";
      try {
        return Utilities.formatDate(new Date(dateObj), Session.getScriptTimeZone(), "yyyy-MM-dd");
      } catch (e) { return ""; }
    };

    for(let i=1; i<data.length; i++) {
      map[data[i][0]] = {
        masuk: toYMD(data[i][1]),
        periksa: toYMD(data[i][2]),
        terima: toYMD(data[i][3]),
        bayar: toYMD(data[i][4])
      };
    }
    return map;
  } catch (e) { return {}; }
}

function saveTanggalSuratData(dbId, formData) {
  try {
    const ss = SpreadsheetApp.openById(dbId);
    const sheet = ensureSheetExists(ss, "Data_Tanggal_Surat");
    const data = sheet.getDataRange().getValues();
    
    let rowIndex = -1;
    // Cari baris berdasarkan ID_TRX
    for(let i=1; i<data.length; i++) {
      if(data[i][0] == formData.id_trx) {
        rowIndex = i + 1; 
        break;
      }
    }
    
    const rowData = [
      formData.id_trx, 
      formData.tgl_masuk,   // Tanggal Surat Masuk (Toko)
      formData.tgl_periksa, // BA Pemeriksaan
      formData.tgl_terima,  // BA Serah Terima
      formData.tgl_bayar    // BA Pembayaran
    ];
    
    if (rowIndex > 0) {
      // Update data lama
      sheet.getRange(rowIndex, 1, 1, 5).setValues([rowData]);
    } else {
      // Insert data baru
      sheet.appendRow(rowData);
    }
    
    return "Data Tanggal Berhasil Disimpan!";
  } catch (e) { return "Error: " + e.toString(); }
}
