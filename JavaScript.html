<script>
    // ==========================================
    // 1. CONFIG & GLOBAL VARIABLES
    // ==========================================
    let DB_ID = localStorage.getItem('bos_db_id');
    let SEKOLAH_NAMA = localStorage.getItem('bos_sekolah_nama');
    
    let CACHE_DROPDOWNS = { toko: [], uraian: [], tukang: [] };
    let TRX_MODE = 'belanja'; 

    let CACHE_DATA = { Data_Uraian: [], Data_Toko: [], Data_Tukang: [], Riwayat: [] };
    let CACHE_NOMOR_SURAT = {}; 
    let CACHE_TANGGAL_SURAT = {}; 
    
    let confirmCallback = null; // Untuk Modal Konfirmasi

    if (DB_ID) { 
        initDashboard(); 
    } else { 
        document.getElementById('authContainer').classList.remove('hidden'); 
    }

    // ==========================================
    // 2. UTILITY & HELPER FUNCTIONS
    // ==========================================
    
    function loader(show) { 
        document.getElementById('loader').style.display = show ? 'flex' : 'none'; 
    }

    function formatRupiah(angka) {
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(angka).replace("Rp", "Rp."); 
    }

    function toggleSidebar() {
        document.getElementById('wrapper').classList.toggle('toggled');
        document.getElementById('sidebar-wrapper').style.marginLeft = document.getElementById('wrapper').classList.contains('toggled') ? "0" : "-15rem";
    }

    // --- FUNGSI ALERT BARU ---
    function showAlert(message, type = 'success') {
        const container = document.getElementById('alertContainer');
        const alertDiv = document.createElement('div');
        
        alertDiv.className = `alert alert-${type} alert-dismissible fade show shadow-sm`;
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        container.appendChild(alertDiv);
        setTimeout(() => {
            if (document.body.contains(alertDiv)) {
                const bsAlert = new bootstrap.Alert(alertDiv);
                bsAlert.close();
            }
        }, 3000);
    }

    // --- FUNGSI KONFIRMASI MODAL ---
    function showConfirm(text, callback) {
        document.getElementById('txtKonfirmasi').innerText = text;
        confirmCallback = callback;
        new bootstrap.Modal(document.getElementById('modalKonfirmasi')).show();
    }
    
    document.getElementById('btnYaKonfirmasi').addEventListener('click', function() {
        if (confirmCallback) confirmCallback();
        bootstrap.Modal.getInstance(document.getElementById('modalKonfirmasi')).hide();
    });

    // ==========================================
    // 3. AUTHENTICATION
    // ==========================================
    
    function switchAuth(type) {
        document.getElementById('btnTabLogin').classList.toggle('active', type === 'login');
        document.getElementById('btnTabReg').classList.toggle('active', type === 'register');
        document.getElementById('formLogin').classList.toggle('hidden', type !== 'login');
        document.getElementById('formRegister').classList.toggle('hidden', type !== 'register');
    }

    // --- UPDATE FUNGSI REGISTER ---
    function handleRegister(e) { 
        e.preventDefault(); 
        
        // Pastikan OTP sudah diisi
        const formData = Object.fromEntries(new FormData(e.target));
        if (!formData.otp_code) {
            showAlert("Silakan minta dan masukkan kode OTP terlebih dahulu!", "warning");
            return;
        }

        loader(true); 
        
        google.script.run.withSuccessHandler(res => { 
            loader(false); 
            if(res.status === 'success') { 
                showAlert(res.message, 'success'); 
                switchAuth('login'); 
                // Reset form
                e.target.reset();
                document.getElementById('divOtpInput').classList.add('hidden');
                document.getElementById('btnDaftarFinal').disabled = true;
                document.getElementById('btnKirimOtp').innerText = "Kirim OTP";
                document.getElementById('btnKirimOtp').disabled = false;
            } else { 
                showAlert(res.message, 'danger'); 
            }
        }).registerUserVerified(formData); // Kita memanggil fungsi backend baru 'registerUserVerified'
    }

    function handleLogin(e) { 
        e.preventDefault(); 
        loader(true); 
        const formData = Object.fromEntries(new FormData(e.target));
        google.script.run.withSuccessHandler(res => { 
            loader(false); 
            if (res.status === 'success') { 
                DB_ID = res.token; 
                SEKOLAH_NAMA = res.sekolah; 
                localStorage.setItem('bos_db_id', DB_ID); 
                localStorage.setItem('bos_sekolah_nama', SEKOLAH_NAMA); 
                initDashboard(); 
            } else { showAlert(res.message, 'danger'); } 
        }).loginUser(formData); 
    }

    function confirmLogout() { 
        showConfirm('Apakah Anda yakin ingin keluar dari aplikasi?', function() {
            localStorage.clear(); 
            location.reload(); 
        });
    }

    function initDashboard() { 
        document.getElementById('authContainer').classList.add('hidden'); 
        document.getElementById('wrapper').classList.remove('hidden'); 
        document.getElementById('displaySekolah').innerText = SEKOLAH_NAMA; 
        toggleSidebar(); 
        openView('dashboard'); 
    }

    // ==========================================
    // 4. NAVIGATION MANAGER
    // ==========================================
    
    // --- UPDATE FUNGSI openView ---
    function openView(viewName) {
        document.querySelectorAll('.app-view').forEach(el => el.classList.add('hidden'));
        document.getElementById('view-' + viewName).classList.remove('hidden');

        if (viewName !== 'transaksi') cancelEditMode(); 

        if (viewName === 'sekolah') loadSekolahData();
        if (viewName === 'dashboard') loadStats();
        if (viewName === 'transaksi') { loadDropdowns(); loadRiwayat(); }
        if (viewName === 'master') loadMasterTable('Data_Uraian');
        if (viewName === 'pengaturan') loadExistingKop();
        
        // TAMBAHAN BARU:
        if (viewName === 'cetak') loadDaftarCetak();
    }

    // ==========================================
    // 5. DASHBOARD & SEKOLAH
    // ==========================================
    
    function loadStats() { 
        google.script.run.withSuccessHandler(res => { 
            document.getElementById('dashAnggaran').innerText = formatRupiah(res.anggaran);
            document.getElementById('dashBelanja').innerText = formatRupiah(res.belanja);
            document.getElementById('dashSisa').innerText = formatRupiah(res.sisa);
            document.getElementById('dashCount').innerText = res.count; 
            const cardSisa = document.getElementById('cardSisa');
            if (res.sisa < 0) cardSisa.classList.replace('bg-success', 'bg-danger'); 
            else cardSisa.classList.replace('bg-danger', 'bg-success');
        }).getDashboardStats(DB_ID); 
    }

    function loadSekolahData() { 
        google.script.run.withSuccessHandler(data => { 
            const f = document.getElementById('formSekolah'); 
            for (const [key, value] of Object.entries(data)) { if (f.elements[key]) f.elements[key].value = value; }
        }).getDataSekolah(DB_ID); 
    }

    function simpanSekolah(e) { 
        e.preventDefault(); 
        loader(true); 
        
        // Ambil data form
        const formData = new FormData(e.target);
        const dataObj = Object.fromEntries(formData);

        // FIX: Tambahkan petik satu pada NIP agar tidak terformat angka
        if (dataObj.nip_kepsek && !dataObj.nip_kepsek.startsWith("'")) {
            dataObj.nip_kepsek = "'" + dataObj.nip_kepsek;
        }
        if (dataObj.nip_bendahara && !dataObj.nip_bendahara.startsWith("'")) {
            dataObj.nip_bendahara = "'" + dataObj.nip_bendahara;
        }

        google.script.run.withSuccessHandler(res => { 
            loader(false); 
            showAlert(res, 'success'); 
        }).saveDataSekolah(DB_ID, dataObj); // Kirim object yang sudah dimodifikasi
    }

    // ==========================================
    // 6. MASTER DATA
    // ==========================================

    function loadMasterTable(type) {
        const tbody = document.getElementById('tbody_' + type);
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">Memuat data...</td></tr>';
        google.script.run.withSuccessHandler(data => {
            CACHE_DATA[type] = data; tbody.innerHTML = '';
            if (!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Belum ada data</td></tr>'; return; }
            data.forEach((row, index) => {
                let html = '';
                const btns = `<td><button class="btn btn-warning btn-sm py-0 px-1" onclick="editMaster('${type}', ${index})"><i class="fas fa-edit"></i></button> <button class="btn btn-danger btn-sm py-0 px-1" onclick="deleteMaster('${type}', ${index})"><i class="fas fa-trash"></i></button></td>`;
                if (type === 'Data_Uraian') html = `<td>${row[0]||''}</td><td>${row[1]||''}</td>${btns}`;
                else if (type === 'Data_Toko') html = `<td><b>${row[0]||'-'}</b><br><small class="text-muted">${row[1]||''}</small></td><td>${row[2]||'-'}<br><small class="text-muted">${row[3]||''}</small></td><td>${row[4]||'-'}</td>${btns}`;
                else if (type === 'Data_Tukang') html = `<td>${row[0]||''}</td><td>${row[1]||''}</td>${btns}`;
                const tr = document.createElement('tr'); tr.innerHTML = html; tbody.appendChild(tr);
            });
        }).getAllMasterData(DB_ID, type);
    }

    function simpanMaster(e, type) { 
        e.preventDefault(); 
        loader(true); 
        const f = e.target; 
        let data = []; 
        const r = f.rowIndex.value; 

        if (type === 'Data_Uraian') {
            data = [f.kode.value, f.nama.value]; 
        }
        else if (type === 'Data_Tukang') {
            data = [f.nama.value, f.alamat.value]; 
        }
        // Di dalam fungsi simpanMaster(e, type) ...
        else if (type === 'Data_Toko') { 
            
            // --- LOGIKA BARU JENIS TOKO ---
            let jenisFinal = f.jenis.value;
            if (jenisFinal === 'Lainnya') {
                jenisFinal = document.getElementById('t_jenis_manual').value;
            }
            // ------------------------------

            // Logika No Telp (dari perbaikan sebelumnya)
            let noTelp = f.telp.value;
            if (noTelp && String(noTelp).trim() !== "" && !noTelp.startsWith("'")) {
                noTelp = "'" + noTelp;
            }

            data = [
                f.nama.value, 
                jenisFinal,      // Gunakan variabel yang sudah dihitung di atas
                f.alamat.value, 
                noTelp, 
                f.pemilik.value, 
                f.tempat.value
            ]; 
        }
        
        google.script.run.withSuccessHandler(res => { 
            loader(false); 
            showAlert(res, 'success'); 
            resetFormMaster(type); 
            loadMasterTable(type); 
        }).saveMasterData(DB_ID, type, data, r); 
    }

    function editMaster(type, index) { 
        const d = CACHE_DATA[type][index]; 
        if (!d) return; 
        
        document.getElementById('idx_'+type).value = index; 
        document.getElementById('btn_'+type).innerText = "Update"; 
        document.getElementById('btn_'+type).classList.replace('btn-primary','btn-warning'); 
        document.getElementById('cancel_'+type).classList.remove('hidden'); 
        
        if (type === 'Data_Uraian') { 
            document.getElementById('u_kode').value = d[0]; 
            document.getElementById('u_nama').value = d[1]; 
        } 
        else if (type === 'Data_Tukang') { 
            document.getElementById('k_nama').value = d[0]; 
            document.getElementById('k_alamat').value = d[1]; 
        } 
        // Di dalam fungsi editMaster(type, index) ...
        else if (type === 'Data_Toko') { 
            document.getElementById('t_nama').value = d[0]; 
            
            // --- LOGIKA LOAD JENIS TOKO ---
            const valJenis = d[1];
            const select = document.getElementById('t_jenis');
            const container = document.getElementById('div_jenis_manual'); // UPDATE INI
            const manualInput = document.getElementById('t_jenis_manual');
            
            let adaDiOpsi = false;
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === valJenis) {
                    adaDiOpsi = true;
                    break;
                }
            }

            if (adaDiOpsi) {
                select.value = valJenis;
                container.classList.add('hidden'); // Sembunyikan container
            } else {
                select.value = 'Lainnya';
                container.classList.remove('hidden'); // Munculkan container
                manualInput.value = valJenis;
            }
            // ------------------------------

            document.getElementById('t_alamat').value = d[2]; 
            
            // Bersihkan tanda kutip untuk tampilan (Logika No Telp)
            let telpView = d[3] ? String(d[3]) : "";
            if (telpView.startsWith("'")) telpView = telpView.substring(1);
            document.getElementById('t_telp').value = telpView; 
            
            document.getElementById('t_pemilik').value = d[4]; 
            document.getElementById('t_tempat').value = d[5] || ""; 
        } 
    }

    function resetFormMaster(type) { 
        document.getElementById('idx_'+type).value = ""; 
        document.getElementById('btn_'+type).innerText = "Simpan"; 
        
        // Reset warna tombol
        if(type === 'Data_Tukang') {
             document.getElementById('btn_'+type).classList.remove('btn-warning'); 
        } else {
             document.getElementById('btn_'+type).classList.replace('btn-warning','btn-primary'); 
        }

        document.getElementById('cancel_'+type).classList.add('hidden'); 
        
        if (type === 'Data_Uraian') { 
            document.getElementById('u_kode').value = ""; 
            document.getElementById('u_nama').value = ""; 
        } 
        if (type === 'Data_Tukang') { 
            document.getElementById('k_nama').value = ""; 
            document.getElementById('k_alamat').value = ""; 
        } 
        // Di dalam fungsi resetFormMaster(type) ...
        if (type === 'Data_Toko') { 
            // Reset field manual juga
            document.getElementById('t_jenis_manual').value = "";
            document.getElementById('div_jenis_manual').classList.add('hidden');

            ['t_nama','t_jenis','t_alamat','t_telp','t_pemilik','t_tempat'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = ""; 
            }); 
        } 
    }

    function deleteMaster(type, index) { 
        showConfirm('Hapus data master ini?', function() {
            loader(true); google.script.run.withSuccessHandler(r => { loader(false); loadMasterTable(type); showAlert(r, 'success'); }).deleteMasterData(DB_ID, type, index); 
        });
    }

    // ==========================================
    // 7. TRANSAKSI LOGIC (EDIT & UPDATE)
    // ==========================================

    function loadDropdowns() { 
        google.script.run.withSuccessHandler(res => { CACHE_DROPDOWNS = res; const u = document.getElementById('trxUraian'); u.innerHTML = '<option value="">Pilih Uraian...</option>'; res.uraian.forEach(x => u.add(new Option(x, x))); renderPihakOptions(); }).getDropdownData(DB_ID); 
    }

    function renderPihakOptions() { 
        const p = document.getElementById('trxPihak'); p.innerHTML = '<option value="">Pilih...</option>'; 
        let listData = (TRX_MODE === 'belanja') ? CACHE_DROPDOWNS.toko : CACHE_DROPDOWNS.tukang; 
        if (listData && listData.length > 0) listData.forEach(x => p.add(new Option(x, x))); 
    }

    function switchTrxMode(mode) { 
        TRX_MODE = mode; 
        document.getElementById('tabBelanja').classList.toggle('active', mode === 'belanja'); 
        document.getElementById('tabTukang').classList.toggle('active', mode === 'tukang'); 
        if (mode === 'belanja') { document.getElementById('titleTrx').innerText = "Input Transaksi Belanja"; document.getElementById('lblPihak').innerText = "Toko"; } 
        else { document.getElementById('titleTrx').innerText = "Input Transaksi Tukang"; document.getElementById('lblPihak').innerText = "Tukang"; } 
        renderPihakOptions(); 
    }
    
    function addRow() { 
        const tr = document.createElement('tr'); 
        tr.innerHTML = `<td><input class="form-control form-control-sm i-nama"></td><td><input type="number" class="form-control form-control-sm i-vol" oninput="cR(this)"></td><td><input class="form-control form-control-sm i-sat"></td><td><input type="number" class="form-control form-control-sm i-harga" oninput="cR(this)"></td><td><input type="text" class="form-control form-control-sm i-total" readonly value="Rp. 0" data-value="0"></td><td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove();cGT()">x</button></td>`; 
        document.getElementById('trxBody').appendChild(tr); 
    }
    function cR(e) { const r = e.closest('tr'); const v = r.querySelector('.i-vol').value || 0; const h = r.querySelector('.i-harga').value || 0; const total = v * h; r.querySelector('.i-total').value = formatRupiah(total); r.querySelector('.i-total').setAttribute('data-value', total); cGT(); }
    function cGT() { let t = 0; document.querySelectorAll('.i-total').forEach(e => { t += Number(e.getAttribute('data-value') || 0); }); document.getElementById('grandTotal').innerText = formatRupiah(t); }
    
    function simpanTransaksi(e) { 
        e.preventDefault(); const f = e.target;
        
        // PERUBAHAN DI SINI: no_bukti diisi string kosong "" karena formnya sudah dihapus
        const h = { 
            tanggal: f.tanggal.value, 
            toko: f.toko.value, 
            uraian: f.uraian.value, 
            no_bukti: "" 
        };

        const it = []; 
        const idEdit = document.getElementById('trxIdEdit').value; 

        document.querySelectorAll('#trxBody tr').forEach(r => { 
            it.push({ 
                nama: r.querySelector('.i-nama').value, 
                vol: r.querySelector('.i-vol').value, 
                sat: r.querySelector('.i-sat').value, 
                harga: r.querySelector('.i-harga').value, 
                total: r.querySelector('.i-total').getAttribute('data-value') || 0 
            });
        }); 
        
        if (it.length === 0) return showAlert("Belum ada barang yang diinput!", "warning"); 
        loader(true); 
        
        google.script.run.withSuccessHandler(r => { 
            loader(false); showAlert(r, 'success'); 
            cancelEditMode(); 
            loadRiwayat(); loadStats(); 
        }).processTransaksiLengkap(DB_ID, h, it, idEdit); 
    }

    // ==========================================
    // 8. RIWAYAT & EDIT (LOGIKA UPDATE TANPA HAPUS)
    // ==========================================

    function loadRiwayat() {
        const tbody = document.getElementById('tbody_riwayat');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div> Memuat...</td></tr>';
        google.script.run.withSuccessHandler(data => {
            CACHE_DATA.Riwayat = data; tbody.innerHTML = '';
            if (!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Belum ada data transaksi.</td></tr>'; return; }
            data.forEach((trx, index) => {
                let itemStr = trx.items.map(i => `&bull; <b>${i.nama}</b> (${i.vol} ${i.sat} @ ${formatRupiah(i.harga)} = ${formatRupiah(i.total)})`).join('<span class="mx-3 text-muted">|</span>');
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${trx.tanggal}</td><td><div class="info-scroll">${trx.toko}</div></td><td><div class="info-scroll">${trx.uraian}</div></td><td><div class="detail-scroll">${itemStr}</div></td><td class="text-end fw-bold text-success">${formatRupiah(trx.total_trx)}</td><td class="col-aksi"><div class="btn-group btn-group-sm"><button class="btn btn-outline-warning" title="Edit" onclick="editTransaksi(${index})"><i class="fas fa-pen"></i></button><button class="btn btn-outline-danger" title="Hapus" onclick="deleteTransaksi('${trx.id}')"><i class="fas fa-trash-alt"></i></button></div></td>`;
                tbody.appendChild(tr);
            });
        }).getRiwayatTransaksiGrouped(DB_ID);
    }

    function deleteTransaksi(idTrx) {
        showConfirm("Yakin ingin menghapus transaksi ini?", function() {
            loader(true); google.script.run.withSuccessHandler(res => { loader(false); loadRiwayat(); loadStats(); showAlert(res, 'success'); }).deleteTransaksiById(DB_ID, idTrx);
        });
    }

    function editTransaksi(index) {
        showConfirm("Edit transaksi ini? Data akan dimuat ke form input.", function() {
            const trx = CACHE_DATA.Riwayat[index];
            if (!trx) return;

            // 1. Scroll ke Form
            document.getElementById('view-transaksi').scrollIntoView({behavior: 'smooth'});

            // 2. Set Mode Edit
            document.getElementById('trxIdEdit').value = trx.id;
            document.getElementById('btnSimpanTrx').innerText = "UPDATE"; 
            document.getElementById('btnSimpanTrx').classList.replace('btn-primary', 'btn-warning');
            document.getElementById('btnBatalEdit').classList.remove('hidden');
            document.getElementById('titleTrx').innerText = "Edit Transaksi: " + trx.id;

            // 3. Isi Header & Logika Cerdas Pihak (Toko/Tukang)
            const namaPihak = trx.toko; 
            
            // Cek apakah nama ini ada di list Tukang
            let isTukang = false;
            if (CACHE_DROPDOWNS.tukang && CACHE_DROPDOWNS.tukang.includes(namaPihak)) {
                isTukang = true;
            }

            // Ganti Tab
            if (isTukang) { switchTrxMode('tukang'); } else { switchTrxMode('belanja'); }

            // Pastikan opsi ada di dropdown (Fix Bug Pihak Kosong)
            const selectPihak = document.getElementById('trxPihak');
            let opsiDitemukan = false;
            for(let i = 0; i < selectPihak.options.length; i++) {
                if (selectPihak.options[i].value === namaPihak) { opsiDitemukan = true; break; }
            }
            if (!opsiDitemukan && namaPihak) {
                selectPihak.add(new Option(namaPihak, namaPihak));
            }
            selectPihak.value = namaPihak;

            // Isi Tanggal
            document.getElementById('trxTanggal').value = trx.tanggal;
            
            // Isi Uraian (dengan pengaman jika data master uraian terhapus)
            const selectUraian = document.getElementById('trxUraian');
            let uraianAda = false;
             for(let i = 0; i < selectUraian.options.length; i++) {
                if (selectUraian.options[i].value === trx.uraian) { uraianAda = true; break; }
            }
            if (!uraianAda && trx.uraian) { selectUraian.add(new Option(trx.uraian, trx.uraian)); }
            selectUraian.value = trx.uraian;

            // --- BAGIAN NO BUKTI DIHAPUS DI SINI ---
            // (Baris pengisian trxBukti sudah dibuang agar tidak error)

            // 4. Isi Body (Barang)
            const tbody = document.getElementById('trxBody'); tbody.innerHTML = ''; 
            trx.items.forEach(item => {
                const tr = document.createElement('tr'); 
                tr.innerHTML = `<td><input class="form-control form-control-sm i-nama" value="${item.nama}"></td><td><input type="number" class="form-control form-control-sm i-vol" value="${item.vol}" oninput="cR(this)"></td><td><input class="form-control form-control-sm i-sat" value="${item.sat}"></td><td><input type="number" class="form-control form-control-sm i-harga" value="${item.harga}" oninput="cR(this)"></td><td><input type="text" class="form-control form-control-sm i-total" readonly value="${formatRupiah(item.total)}" data-value="${item.total}"></td><td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove();cGT()">x</button></td>`; 
                tbody.appendChild(tr);
            });
            cGT(); 
            showAlert("Mode Edit Aktif. Silakan ubah data dan klik Update.", "info");
        });
    }

    function cancelEditMode() {
        document.getElementById('formTrx').reset();
        document.getElementById('trxBody').innerHTML = '';
        document.getElementById('grandTotal').innerText = "Rp. 0";
        document.getElementById('trxIdEdit').value = ""; 
        document.getElementById('btnSimpanTrx').innerText = "SIMPAN";
        document.getElementById('btnSimpanTrx').classList.replace('btn-warning', 'btn-primary');
        document.getElementById('btnBatalEdit').classList.add('hidden');
        document.getElementById('titleTrx').innerText = "Input Transaksi Belanja"; 
        
        // Hapus baris reset trxBukti jika ada, atau biarkan formTrx.reset() yang menanganinya (aman).
        
        switchTrxMode('belanja'); addRow(); 
    }

    // ==========================================
    // 9. PENGATURAN CETAK
    // ==========================================

    function previewKop(input) { if (input.files && input.files[0]) { var reader = new FileReader(); reader.onload = function (e) { document.getElementById('previewImgKop').src = e.target.result; document.getElementById('previewImgKop').style.display = 'block'; document.getElementById('noKopText').style.display = 'none'; }; reader.readAsDataURL(input.files[0]); } }
    function uploadKopSurat() { const input = document.getElementById('fileKop'); if (!input.files || !input.files[0]) return showAlert("Pilih file gambar dulu!", "warning"); loader(true); const file = input.files[0]; const reader = new FileReader(); reader.onload = function(e) { const content = e.target.result.split(',')[1]; google.script.run.withSuccessHandler(res => { loader(false); if(res.status === 'success') { showAlert("Kop Surat berhasil disimpan!", "success"); try { localStorage.setItem('bos_kop_image', res.url); } catch (e) {} document.getElementById('previewImgKop').src = res.url; document.getElementById('previewImgKop').style.display = 'block'; document.getElementById('noKopText').style.display = 'none'; } else { showAlert("Gagal: " + res.message, "danger"); } }).saveKopSuratToDrive(DB_ID, content, file.type, SEKOLAH_NAMA); }; reader.readAsDataURL(file); }
    function loadExistingKop() { const img = document.getElementById('previewImgKop'); const txt = document.getElementById('noKopText'); const cachedKop = localStorage.getItem('bos_kop_image'); if (cachedKop) { img.src = cachedKop; img.style.display = 'block'; txt.style.display = 'none'; } google.script.run.withSuccessHandler(url => { if(url) { if (url !== cachedKop) { img.src = url; img.style.display = 'block'; txt.style.display = 'none'; try { localStorage.setItem('bos_kop_image', url); } catch (e) {} } } else { if (cachedKop) { localStorage.removeItem('bos_kop_image'); img.style.display = 'none'; txt.style.display = 'block'; } else { img.style.display = 'none'; txt.style.display = 'block'; } } }).getKopSuratUrl(DB_ID); }

    function loadPengaturanNomor() { const tbody = document.getElementById('tbody_setting_nomor'); tbody.innerHTML = '<tr><td colspan="5" class="text-center">Memuat data transaksi...</td></tr>'; google.script.run.withSuccessHandler(trxData => { google.script.run.withSuccessHandler(nomorData => { CACHE_NOMOR_SURAT = nomorData; renderTableNomor(trxData, nomorData); }).getNomorSuratData(DB_ID); }).getRiwayatTransaksiGrouped(DB_ID); }
    function renderTableNomor(trxList, nomorMap) { const tbody = document.getElementById('tbody_setting_nomor'); tbody.innerHTML = ''; if (!trxList || trxList.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center">Belum ada transaksi.</td></tr>'; return; } trxList.forEach(trx => { const id = trx.id; const saved = nomorMap[id]; let statusBadge = '<span class="badge bg-danger">Belum Diisi</span>'; if (saved && saved.keluar && saved.bayar) statusBadge = '<span class="badge bg-success">Sudah Diisi</span>'; const tr = document.createElement('tr'); tr.innerHTML = `<td>${trx.tanggal}</td><td>${trx.toko}</td><td>${trx.uraian}</td><td class="text-center">${statusBadge}</td><td class="text-center"><button class="btn btn-primary btn-sm" onclick="openModalNomor('${id}', '${trx.toko}')"><i class="fas fa-list-ol"></i> Input No</button></td>`; tbody.appendChild(tr); }); }
    function openModalNomor(trxId, pihakName) { document.getElementById('formNomorSurat').reset(); document.getElementById('ns_id_trx').value = trxId; let isTukang = (CACHE_DROPDOWNS.tukang && CACHE_DROPDOWNS.tukang.includes(pihakName)); document.getElementById('ns_jenis_pihak').value = isTukang ? 'tukang' : 'toko'; const inputMasuk = document.getElementById('ns_masuk'); if (isTukang) { inputMasuk.disabled = true; inputMasuk.value = ""; inputMasuk.placeholder = "Tidak perlu diisi (Jasa Tukang)"; document.getElementById('lbl_ns_periksa').innerText = "Pekerjaan"; document.getElementById('lbl_ns_terima').innerText = "Pekerjaan"; } else { inputMasuk.disabled = false; inputMasuk.placeholder = "Nomor Nota/Faktur"; document.getElementById('lbl_ns_periksa').innerText = "Barang"; document.getElementById('lbl_ns_terima').innerText = "Barang"; } const saved = CACHE_NOMOR_SURAT[trxId]; if (saved) { document.getElementById('ns_keluar').value = saved.keluar || ''; if (!isTukang) document.getElementById('ns_masuk').value = saved.masuk || ''; document.getElementById('ns_periksa').value = saved.periksa || ''; document.getElementById('ns_terima').value = saved.terima || ''; document.getElementById('ns_bayar').value = saved.bayar || ''; } new bootstrap.Modal(document.getElementById('modalNomorSurat')).show(); }
    function simpanNomorSurat(e) { e.preventDefault(); loader(true); const f = e.target; const data = { id_trx: f.id_trx.value, no_keluar: f.no_keluar.value, no_masuk: f.no_masuk.value, no_periksa: f.no_periksa.value, no_terima: f.no_terima.value, no_bayar: f.no_bayar.value }; google.script.run.withSuccessHandler(res => { loader(false); bootstrap.Modal.getInstance(document.getElementById('modalNomorSurat')).hide(); loadPengaturanNomor(); showAlert(res, 'success'); }).saveNomorSuratData(DB_ID, data); }
    
    function loadPengaturanTanggal() { const tbody = document.getElementById('tbody_setting_tanggal'); tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm"></div> Memuat data...</td></tr>'; google.script.run.withSuccessHandler(trxData => { google.script.run.withSuccessHandler(tanggalData => { CACHE_TANGGAL_SURAT = tanggalData; renderTableTanggal(trxData, tanggalData); }).getTanggalSuratData(DB_ID); }).getRiwayatTransaksiGrouped(DB_ID); }
    function renderTableTanggal(trxList, tanggalMap) { const tbody = document.getElementById('tbody_setting_tanggal'); tbody.innerHTML = ''; if (!trxList || trxList.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center">Belum ada transaksi.</td></tr>'; return; } trxList.forEach(trx => { const id = trx.id; const saved = tanggalMap[id]; let statusBadge = '<span class="badge bg-danger">Belum Diisi</span>'; if (saved && saved.bayar) statusBadge = '<span class="badge bg-success">Sudah Diisi</span>'; const tr = document.createElement('tr'); tr.innerHTML = `<td>${trx.tanggal}</td><td>${trx.toko}</td><td>${trx.uraian}</td><td class="text-center">${statusBadge}</td><td class="text-center"><button class="btn btn-warning btn-sm" onclick="openModalTanggal('${id}', '${trx.toko}')"><i class="fas fa-calendar-day"></i> Set Tanggal</button></td>`; tbody.appendChild(tr); }); }
    function openModalTanggal(trxId, pihakName) { document.getElementById('formTanggalSurat').reset(); document.getElementById('ts_id_trx').value = trxId; let isTukang = (CACHE_DROPDOWNS.tukang && CACHE_DROPDOWNS.tukang.includes(pihakName)); document.getElementById('ts_jenis_pihak').value = isTukang ? 'tukang' : 'toko'; const inputTglMasuk = document.getElementById('ts_masuk'); if (isTukang) { inputTglMasuk.disabled = true; inputTglMasuk.value = ""; document.getElementById('lbl_ts_periksa').innerText = "Pekerjaan"; document.getElementById('lbl_ts_terima').innerText = "Pekerjaan"; } else { inputTglMasuk.disabled = false; document.getElementById('lbl_ts_periksa').innerText = "Barang"; document.getElementById('lbl_ts_terima').innerText = "Barang"; } const saved = CACHE_TANGGAL_SURAT[trxId]; if (saved) { if (!isTukang) document.getElementById('ts_masuk').value = saved.masuk || ''; document.getElementById('ts_periksa').value = saved.periksa || ''; document.getElementById('ts_terima').value = saved.terima || ''; document.getElementById('ts_bayar').value = saved.bayar || ''; } new bootstrap.Modal(document.getElementById('modalTanggalSurat')).show(); }
    function simpanTanggalSurat(e) { e.preventDefault(); loader(true); const f = e.target; const data = { id_trx: f.id_trx.value, tgl_masuk: f.tgl_masuk.value, tgl_periksa: f.tgl_periksa.value, tgl_terima: f.tgl_terima.value, tgl_bayar: f.tgl_bayar.value }; google.script.run.withSuccessHandler(res => { loader(false); bootstrap.Modal.getInstance(document.getElementById('modalTanggalSurat')).hide(); loadPengaturanTanggal(); showAlert(res, 'success'); }).saveTanggalSuratData(DB_ID, data); }

    function toggleJenisLainnya() {
        const select = document.getElementById('t_jenis');
        const container = document.getElementById('div_jenis_manual'); // Ambil Div pembungkus
        const manualInput = document.getElementById('t_jenis_manual'); // Ambil Inputnya
        
        if (select.value === 'Lainnya') {
            container.classList.remove('hidden'); // Munculkan pembungkusnya
            manualInput.setAttribute('required', 'true');
            manualInput.focus();
        } else {
            container.classList.add('hidden'); // Sembunyikan pembungkusnya
            manualInput.removeAttribute('required');
            manualInput.value = ''; 
        }
    }
    
    // --- FUNGSI BARU UNTUK HALAMAN CETAK ---

    function loadDaftarCetak() {
        const tbody = document.getElementById('tbody_cetak');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Memuat data transaksi...</td></tr>';
        
        google.script.run.withSuccessHandler(data => {
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Belum ada transaksi.</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            data.forEach(trx => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${trx.tanggal}</td>
                    <td>${trx.toko}</td>
                    <td>${trx.uraian}</td>
                    <td class="text-end fw-bold">${formatRupiah(trx.total_trx)}</td>
                    <td class="text-center">
                        <button class="btn btn-danger btn-sm" onclick="printLaporan('${trx.id}')">
                            <i class="fas fa-file-pdf"></i> Cetak PDF (7 Hal)
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }).getRiwayatTransaksiGrouped(DB_ID);
    }

    function printLaporan(idTrx) {
        showConfirm("Generate PDF Laporan Lengkap (7 Halaman)? Proses ini memakan waktu beberapa detik.", function() {
            loader(true);
            google.script.run.withSuccessHandler(res => {
                loader(false);
                if(res.status === 'success') {
                    // Buka PDF di tab baru
                    window.open(res.url, '_blank');
                } else {
                    showAlert("Gagal: " + res.message, 'danger');
                }
            }).generatePDFLaporan(DB_ID, idTrx);
        });
    }

    // --- FUNGSI BARU: REQUEST OTP ---
    function requestOtp() {
        const emailEl = document.getElementById('regEmail');
        const email = emailEl.value;
        const btnOtp = document.getElementById('btnKirimOtp');

        if (!email || !email.includes('@')) {
            showAlert("Mohon isi email yang valid terlebih dahulu!", "warning");
            return;
        }

        // UI Loading state
        btnOtp.disabled = true;
        btnOtp.innerText = "Mengirim...";
        loader(true);

        google.script.run.withSuccessHandler(res => {
            loader(false);
            if (res.status === 'success') {
                showAlert(res.message, 'success');
                
                // Tampilkan input OTP dan Aktifkan tombol Daftar
                document.getElementById('divOtpInput').classList.remove('hidden');
                document.getElementById('btnDaftarFinal').disabled = false;
                
                // Ubah tampilan tombol OTP agar user tau sudah dikirim
                btnOtp.innerText = "Kirim Ulang";
                
                // Timer sederhana agar tidak spam (60 detik)
                let countdown = 60;
                const timer = setInterval(() => {
                    btnOtp.innerText = `Tunggu ${countdown}s`;
                    countdown--;
                    if (countdown < 0) {
                        clearInterval(timer);
                        btnOtp.disabled = false;
                        btnOtp.innerText = "Kirim Ulang OTP";
                    }
                }, 1000);
                
            } else {
                showAlert(res.message, 'danger');
                btnOtp.disabled = false;
                btnOtp.innerText = "Kirim OTP";
            }
        }).sendOtpRegistration(email);
    }

    // Init Empty Row
    addRow();
</script>
