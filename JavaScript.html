<script>
    // ==========================================
    // 1. CONFIG & GLOBAL VARIABLES
    // ==========================================
    let DB_ID = localStorage.getItem('bos_db_id');
    let SEKOLAH_NAMA = localStorage.getItem('bos_sekolah_nama');
    
    // UPDATE: Cache tambahan untuk Dropdown agar mudah switch tab
    let CACHE_DROPDOWNS = { toko: [], uraian: [], tukang: [] };
    let TRX_MODE = 'belanja'; // Default: Belanja

    // Cache sederhana untuk menyimpan data sementara agar tidak bolak-balik request
    let CACHE_DATA = { 
        Data_Uraian: [], 
        Data_Toko: [], 
        Data_Tukang: [], 
        Riwayat: [] 
    };

    // Cek Login saat halaman dimuat
    if (DB_ID) { 
        initDashboard(); 
    } else { 
        document.getElementById('authContainer').classList.remove('hidden'); 
    }

    // ==========================================
    // 2. UTILITY FUNCTIONS (Fungsi Bantuan)
    // ==========================================
    
    // Tampilkan/Sembunyikan Loader
    function loader(show) { 
        document.getElementById('loader').style.display = show ? 'flex' : 'none'; 
    }

    // Format Format Rupiah (Rp. 100.000)
    function formatRupiah(angka) {
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(angka).replace("Rp", "Rp."); // Menambah titik setelah Rp
    }

    // Toggle Sidebar Menu
    function toggleSidebar() {
        document.getElementById('wrapper').classList.toggle('toggled');
        const sidebar = document.getElementById('sidebar-wrapper');
        sidebar.style.marginLeft = document.getElementById('wrapper').classList.contains('toggled') ? "0" : "-15rem";
    }

    // ==========================================
    // 3. AUTHENTICATION (Login/Register/Logout)
    // ==========================================
    
    function switchAuth(type) {
        document.getElementById('btnTabLogin').classList.toggle('active', type === 'login');
        document.getElementById('btnTabReg').classList.toggle('active', type === 'register');
        document.getElementById('formLogin').classList.toggle('hidden', type !== 'login');
        document.getElementById('formRegister').classList.toggle('hidden', type !== 'register');
    }

    function handleRegister(e) { 
        e.preventDefault(); 
        loader(true); 
        const formData = Object.fromEntries(new FormData(e.target));
        
        google.script.run.withSuccessHandler(res => { 
            loader(false); 
            alert(res.message); 
            if(res.status === 'success') switchAuth('login'); 
        }).registerUser(formData); 
    }

    function handleLogin(e) { 
        e.preventDefault(); 
        loader(true); 
        const formData = Object.fromEntries(new FormData(e.target));
        
        google.script.run.withSuccessHandler(res => { 
            loader(false); 
            if (res.status === 'success') { 
                DB_ID = res.token; 
                SEKOLAH_NAMA = res.sekolah; 
                localStorage.setItem('bos_db_id', DB_ID); 
                localStorage.setItem('bos_sekolah_nama', SEKOLAH_NAMA); 
                initDashboard(); 
            } else { 
                alert(res.message); 
            } 
        }).loginUser(formData); 
    }

    function logout() { 
        if (confirm('Keluar dari aplikasi?')) { 
            localStorage.clear(); 
            location.reload(); 
        } 
    }

    function initDashboard() { 
        document.getElementById('authContainer').classList.add('hidden'); 
        document.getElementById('wrapper').classList.remove('hidden'); 
        document.getElementById('displaySekolah').innerText = SEKOLAH_NAMA; 
        
        toggleSidebar(); 
        openView('dashboard'); 
    }

    // ==========================================
    // 4. NAVIGATION MANAGER
    // ==========================================
    
    function openView(viewName) {
        // Sembunyikan semua view
        document.querySelectorAll('.app-view').forEach(el => el.classList.add('hidden'));
        
        // Tampilkan view yang dipilih
        document.getElementById('view-' + viewName).classList.remove('hidden');

        // Load data spesifik sesuai halaman yang dibuka
        if (viewName === 'sekolah') loadSekolahData();
        if (viewName === 'dashboard') loadStats();
        if (viewName === 'transaksi') { 
            loadDropdowns(); 
            loadRiwayat(); 
        }
        // TAMBAHAN BARU
        if (viewName === 'pengaturan') {
            loadExistingKop();
            // Default tab
        }
        if (viewName === 'master') loadMasterTable('Data_Uraian');
    }

    // ==========================================
    // 5. DASHBOARD LOGIC
    // ==========================================
    
    function loadStats() { 
        google.script.run.withSuccessHandler(res => { 
            // Update Angka di Kartu
            document.getElementById('dashAnggaran').innerText = formatRupiah(res.anggaran);
            document.getElementById('dashBelanja').innerText = formatRupiah(res.belanja);
            document.getElementById('dashSisa').innerText = formatRupiah(res.sisa);
            document.getElementById('dashCount').innerText = res.count; 
            
            // Logic Warna Sisa Anggaran (Merah jika minus)
            const cardSisa = document.getElementById('cardSisa');
            if (res.sisa < 0) {
                cardSisa.classList.remove('bg-success');
                cardSisa.classList.add('bg-danger'); 
            } else {
                cardSisa.classList.remove('bg-danger');
                cardSisa.classList.add('bg-success');
            }
        }).getDashboardStats(DB_ID); 
    }

    // ==========================================
    // 6. DATA SEKOLAH LOGIC
    // ==========================================
    
    function loadSekolahData() { 
        google.script.run.withSuccessHandler(data => { 
            const f = document.getElementById('formSekolah'); 
            for (const [key, value] of Object.entries(data)) {
                if (f.elements[key]) f.elements[key].value = value;
            }
        }).getDataSekolah(DB_ID); 
    }

    function simpanSekolah(e) { 
        e.preventDefault(); 
        loader(true); 
        const formData = Object.fromEntries(new FormData(e.target));
        
        google.script.run.withSuccessHandler(res => { 
            loader(false); 
            alert(res); 
        }).saveDataSekolah(DB_ID, formData); 
    }

    // ==========================================
    // 7. MASTER DATA LOGIC
    // ==========================================

    function loadMasterTable(type) {
        const tbody = document.getElementById('tbody_' + type);
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">Memuat data...</td></tr>';
        
        google.script.run.withSuccessHandler(data => {
            CACHE_DATA[type] = data; 
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Belum ada data</td></tr>'; 
                return; 
            }
            
            data.forEach((row, index) => {
                let html = '';
                const btns = `
                    <td>
                        <button class="btn btn-warning btn-sm py-0 px-1" onclick="editMaster('${type}', ${index})"><i class="fas fa-edit"></i></button> 
                        <button class="btn btn-danger btn-sm py-0 px-1" onclick="deleteMaster('${type}', ${index})"><i class="fas fa-trash"></i></button>
                    </td>`;
                
                if (type === 'Data_Uraian') {
                    html = `<td>${row[0]||''}</td><td>${row[1]||''}</td>${btns}`;
                } else if (type === 'Data_Toko') {
                    html = `<td><b>${row[0]||'-'}</b><br><small class="text-muted">${row[1]||''}</small></td>
                            <td>${row[2]||'-'}<br><small class="text-muted">${row[3]||''}</small></td>
                            <td>${row[4]||'-'}</td>${btns}`;
                } else if (type === 'Data_Tukang') {
                    html = `<td>${row[0]||''}</td><td>${row[1]||''}</td>${btns}`;
                }
                
                const tr = document.createElement('tr'); 
                tr.innerHTML = html; 
                tbody.appendChild(tr);
            });
        }).getAllMasterData(DB_ID, type);
    }

    function simpanMaster(e, type) { 
        e.preventDefault(); 
        loader(true); 
        const f = e.target; 
        let data = []; 
        const r = f.rowIndex.value; 

        if (type === 'Data_Uraian') data = [f.kode.value, f.nama.value]; 
        if (type === 'Data_Tukang') data = [f.nama.value, f.alamat.value]; 
        if (type === 'Data_Toko') { 
            let tgl = ""; 
            if (f.tgl_ttd.value) {
                try { tgl = new Date(f.tgl_ttd.value).toISOString().slice(0,10); } catch(er){}
            } 
            data = [f.nama.value, f.jenis.value, f.alamat.value, f.telp.value, f.pemilik.value, tgl]; 
        } 
        
        google.script.run.withSuccessHandler(res => { 
            loader(false); 
            alert(res); 
            resetFormMaster(type); 
            loadMasterTable(type); 
        }).saveMasterData(DB_ID, type, data, r); 
    }

    function editMaster(type, index) { 
        const d = CACHE_DATA[type][index]; 
        if (!d) return; 

        document.getElementById('idx_'+type).value = index; 
        document.getElementById('btn_'+type).innerText = "Update"; 
        document.getElementById('btn_'+type).classList.replace('btn-primary','btn-warning'); 
        document.getElementById('cancel_'+type).classList.remove('hidden'); 

        if (type === 'Data_Uraian') {
            document.getElementById('u_kode').value = d[0];
            document.getElementById('u_nama').value = d[1];
        } else if (type === 'Data_Tukang') {
            document.getElementById('k_nama').value = d[0];
            document.getElementById('k_alamat').value = d[1];
        } else if (type === 'Data_Toko') {
            document.getElementById('t_nama').value = d[0];
            document.getElementById('t_jenis').value = d[1];
            document.getElementById('t_alamat').value = d[2];
            document.getElementById('t_telp').value = d[3];
            document.getElementById('t_pemilik').value = d[4]; 
            let dv = ""; 
            if(d[5]) { const x = new Date(d[5]); if(!isNaN(x)) dv = x.toISOString().split('T')[0]; } 
            document.getElementById('t_tgl_ttd').value = dv;
        } 
    }

    function resetFormMaster(type) { 
        document.getElementById('idx_'+type).value = ""; 
        document.getElementById('btn_'+type).innerText = "Simpan"; 
        document.getElementById('btn_'+type).classList.replace('btn-warning','btn-primary'); 
        document.getElementById('cancel_'+type).classList.add('hidden'); 
        
        if (type === 'Data_Uraian') {
            document.getElementById('u_kode').value = "";
            document.getElementById('u_nama').value = "";
        } 
        if (type === 'Data_Tukang') {
            document.getElementById('k_nama').value = "";
            document.getElementById('k_alamat').value = "";
        } 
        if (type === 'Data_Toko') {
            ['t_nama','t_jenis','t_alamat','t_telp','t_pemilik','t_tgl_ttd'].forEach(id => document.getElementById(id).value = "");
        } 
    }

    function deleteMaster(type, index) { 
        if (!confirm("Hapus data ini?")) return; 
        loader(true); 
        google.script.run.withSuccessHandler(r => {
            loader(false);
            loadMasterTable(type);
        }).deleteMasterData(DB_ID, type, index); 
    }

    // ==========================================
    // 8. TRANSAKSI LOGIC (Input & Kalkulasi)
    // ==========================================

    // UPDATE: Fungsi Load Dropdowns diperbarui untuk support switching
    function loadDropdowns() { 
        google.script.run.withSuccessHandler(res => { 
            CACHE_DROPDOWNS = res; // Simpan ke global variable
            
            // Render Uraian
            const u = document.getElementById('trxUraian'); 
            u.innerHTML = '<option value="">Pilih Uraian...</option>'; 
            res.uraian.forEach(x => u.add(new Option(x, x))); 
            
            // Render Pihak (Toko/Tukang) sesuai mode
            renderPihakOptions();

        }).getDropdownData(DB_ID); 
    }

    // UPDATE: Fungsi Baru Render Pilihan (Toko/Tukang)
    function renderPihakOptions() {
        const p = document.getElementById('trxPihak');
        p.innerHTML = '<option value="">Pilih...</option>';
        
        let listData = (TRX_MODE === 'belanja') ? CACHE_DROPDOWNS.toko : CACHE_DROPDOWNS.tukang;
        if (listData && listData.length > 0) {
            listData.forEach(x => p.add(new Option(x, x)));
        }
    }

    // UPDATE: Fungsi Switch Mode Tab
    function switchTrxMode(mode) {
        TRX_MODE = mode;
        
        // Update Class Active Tab
        document.getElementById('tabBelanja').classList.toggle('active', mode === 'belanja');
        document.getElementById('tabTukang').classList.toggle('active', mode === 'tukang');
        
        // Update Teks Judul & Label
        if (mode === 'belanja') {
            document.getElementById('titleTrx').innerText = "Input Transaksi Belanja";
            document.getElementById('lblPihak').innerText = "Toko";
        } else {
            document.getElementById('titleTrx').innerText = "Input Transaksi Tukang";
            document.getElementById('lblPihak').innerText = "Tukang";
        }
        
        // Render Ulang Dropdown
        renderPihakOptions();
    }

    function addRow() { 
        const tr = document.createElement('tr'); 
        tr.innerHTML = `
            <td><input class="form-control form-control-sm i-nama"></td>
            <td><input type="number" class="form-control form-control-sm i-vol" oninput="cR(this)"></td>
            <td><input class="form-control form-control-sm i-sat"></td>
            <td><input type="number" class="form-control form-control-sm i-harga" oninput="cR(this)"></td>
            <td><input type="text" class="form-control form-control-sm i-total" readonly value="Rp. 0" data-value="0"></td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove();cGT()">x</button></td>
        `; 
        document.getElementById('trxBody').appendChild(tr); 
    }

    // Calculate Row (Hitung per baris)
    function cR(e) { 
        const r = e.closest('tr'); 
        const v = r.querySelector('.i-vol').value || 0; 
        const h = r.querySelector('.i-harga').value || 0; 
        const total = v * h;
        
        const elTotal = r.querySelector('.i-total');
        elTotal.value = formatRupiah(total);       // Tampilan (Rp. xxx)
        elTotal.setAttribute('data-value', total); // Data Asli (angka)
        
        cGT(); 
    }

    // Calculate Grand Total (Hitung Total Semua)
    function cGT() { 
        let t = 0; 
        document.querySelectorAll('.i-total').forEach(e => {
            // Ambil dari data-value bukan value karena value isinya string Rp
            t += Number(e.getAttribute('data-value') || 0);
        }); 
        document.getElementById('grandTotal').innerText = formatRupiah(t); 
    }
    
    function simpanTransaksi(e) { 
        e.preventDefault(); 
        const f = e.target;
        const h = {
            tanggal: f.tanggal.value, 
            toko: f.toko.value, 
            uraian: f.uraian.value, 
            no_bukti: f.no_bukti.value
        };
        const it = []; 
        
        document.querySelectorAll('#trxBody tr').forEach(r => { 
            const rawTotal = r.querySelector('.i-total').getAttribute('data-value') || 0;
            it.push({
                nama: r.querySelector('.i-nama').value, 
                vol: r.querySelector('.i-vol').value, 
                sat: r.querySelector('.i-sat').value, 
                harga: r.querySelector('.i-harga').value, 
                total: rawTotal // Kirim angka murni ke server
            });
        }); 
        
        if (it.length === 0) return alert("Belum ada barang yang diinput!"); 
        loader(true); 
        
        google.script.run.withSuccessHandler(r => { 
            loader(false); 
            alert(r); 
            f.reset(); 
            document.getElementById('trxBody').innerHTML = ''; 
            document.getElementById('grandTotal').innerText = "Rp. 0";
            addRow();
            
            // Kembalikan ke Mode Default
            switchTrxMode('belanja');
            
            loadRiwayat();
            loadStats(); 
        }).processTransaksiLengkap(DB_ID, h, it); 
    }

    // ==========================================
    // 9. RIWAYAT & EDIT DATA
    // ==========================================

    function loadRiwayat() {
        const tbody = document.getElementById('tbody_riwayat');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div> Memuat...</td></tr>';
        
        google.script.run.withSuccessHandler(data => {
            CACHE_DATA.Riwayat = data; 
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Belum ada data transaksi.</td></tr>';
                return;
            }
            
            data.forEach((trx, index) => {
                // Format item barang agar ada Rp. nya
                let itemStr = trx.items.map(i => {
                    const hargaFmt = formatRupiah(i.harga);
                    const totalFmt = formatRupiah(i.total);
                    return `&bull; <b>${i.nama}</b> (${i.vol} ${i.sat} @ ${hargaFmt} = ${totalFmt})`;
                }).join('<span class="mx-3 text-muted">|</span>');
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td width="100">${trx.tanggal}</td>
                    <td>
                        <div class="info-scroll">${trx.toko}</div>
                    </td>
                    <td>
                        <div class="info-scroll">${trx.uraian}</div>
                    </td>
                    <td>
                        <div class="detail-scroll">
                            ${itemStr}
                        </div>
                    </td>
                    <td class="text-end fw-bold text-success">${formatRupiah(trx.total_trx)}</td>
                    <td class="col-aksi">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-warning" title="Edit" onclick="editTransaksi(${index})"><i class="fas fa-pen"></i></button>
                            <button class="btn btn-outline-danger" title="Hapus" onclick="deleteTransaksi('${trx.id}')"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }).getRiwayatTransaksiGrouped(DB_ID);
    }

    function deleteTransaksi(idTrx) {
        if (!confirm("Yakin ingin menghapus transaksi ini?")) return;
        loader(true);
        google.script.run.withSuccessHandler(res => {
            loader(false);
            loadRiwayat();
            loadStats(); // Update dashboard juga
        }).deleteTransaksiById(DB_ID, idTrx);
    }

    function editTransaksi(index) {
        if (!confirm("Edit Transaksi? Data akan dimuat ke form dan dihapus dari tabel riwayat sementara.")) return;
        
        const trx = CACHE_DATA.Riwayat[index];
        if (!trx) return;

        // UPDATE LOGIC: Cek apakah nama Toko/Pihak ada di data tukang
        // Jika iya, switch ke mode Tukang, jika tidak default ke Toko
        if (CACHE_DROPDOWNS.tukang && CACHE_DROPDOWNS.tukang.includes(trx.toko)) {
            switchTrxMode('tukang');
        } else {
            switchTrxMode('belanja');
        }

        // Isi Form Header
        document.getElementById('trxTanggal').value = trx.tanggal;
        document.getElementById('trxPihak').value = trx.toko; // ID Updated
        document.getElementById('trxUraian').value = trx.uraian;
        document.getElementById('trxBukti').value = trx.no_bukti;

        // Isi Tabel Item Barang
        const tbody = document.getElementById('trxBody');
        tbody.innerHTML = ''; 
        
        trx.items.forEach(item => {
            const tr = document.createElement('tr'); 
            const totalFmt = formatRupiah(item.total);
            tr.innerHTML = `
                <td><input class="form-control form-control-sm i-nama" value="${item.nama}"></td>
                <td><input type="number" class="form-control form-control-sm i-vol" value="${item.vol}" oninput="cR(this)"></td>
                <td><input class="form-control form-control-sm i-sat" value="${item.sat}"></td>
                <td><input type="number" class="form-control form-control-sm i-harga" value="${item.harga}" oninput="cR(this)"></td>
                <td><input type="text" class="form-control form-control-sm i-total" readonly value="${totalFmt}" data-value="${item.total}"></td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove();cGT()">x</button></td>
            `; 
            tbody.appendChild(tr);
        });
        
        cGT(); // Hitung ulang Grand Total
        loader(true);
        
        // Hapus data lama di server karena akan disimpan ulang sebagai transaksi baru (edit flow)
        google.script.run.withSuccessHandler(() => {
            loader(false);
            loadRiwayat(); 
            // Scroll ke form input
            document.getElementById('view-transaksi').scrollIntoView({behavior: 'smooth'});
        }).deleteTransaksiById(DB_ID, trx.id);
    }
    
    // Tambah baris kosong saat pertama kali load
    addRow();

    // ==========================================
    // 10. LOGIC PENGATURAN CETAK
    // ==========================================

    // --- A. KOP SURAT (UPDATED) ---
    function previewKop(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('previewImgKop').src = e.target.result;
                document.getElementById('previewImgKop').style.display = 'block';
                document.getElementById('noKopText').style.display = 'none';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function uploadKopSurat() {
        const input = document.getElementById('fileKop');
        if (!input.files || !input.files[0]) return alert("Pilih file gambar dulu!");
        
        loader(true);
        const file = input.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const content = e.target.result.split(',')[1]; // Ambil base64-nya saja
            
            // PERBAIKAN: Parameter pertama sekarang adalah DB_ID
            google.script.run.withSuccessHandler(res => {
                loader(false);
                if(res.status === 'success') {
                    alert("Kop Surat berhasil disimpan ke Database!");
                } else {
                    alert("Gagal: " + res.message);
                }
            }).saveKopSuratToDrive(DB_ID, content, file.type, SEKOLAH_NAMA);
        };
        reader.readAsDataURL(file);
    }

    function loadExistingKop() {
        // PERBAIKAN: Kirim DB_ID untuk lookup ke Data_Sekolah
        google.script.run.withSuccessHandler(url => {
            if(url) {
                document.getElementById('previewImgKop').src = url;
                document.getElementById('previewImgKop').style.display = 'block';
                document.getElementById('noKopText').style.display = 'none';
            } else {
                // Jika tidak ada data
                document.getElementById('previewImgKop').style.display = 'none';
                document.getElementById('noKopText').style.display = 'block';
            }
        }).getKopSuratUrl(DB_ID);
    }

    // --- B. NOMOR SURAT ---
    
    let CACHE_NOMOR_SURAT = {};

    function loadPengaturanNomor() {
        const tbody = document.getElementById('tbody_setting_nomor');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Memuat data transaksi...</td></tr>';
        
        // 1. Ambil Transaksi
        google.script.run.withSuccessHandler(trxData => {
            // 2. Ambil Data Nomor yang sudah tersimpan
            google.script.run.withSuccessHandler(nomorData => {
                CACHE_NOMOR_SURAT = nomorData; // Simpan di cache {trxId: {keluar:..., masuk:...}}
                renderTableNomor(trxData, nomorData);
            }).getNomorSuratData(DB_ID);
        }).getRiwayatTransaksiGrouped(DB_ID);
    }

    function renderTableNomor(trxList, nomorMap) {
        const tbody = document.getElementById('tbody_setting_nomor');
        tbody.innerHTML = '';
        
        if (!trxList || trxList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Belum ada transaksi. Input transaksi dulu.</td></tr>';
            return;
        }

        trxList.forEach(trx => {
            const id = trx.id;
            const saved = nomorMap[id];
            
            // Cek status kelengkapan
            let statusBadge = '<span class="badge bg-danger">Belum Diisi</span>';
            if (saved && saved.keluar && saved.bayar) { // Logika sederhana: jika ada no keluar & bayar dianggap "Terisi"
                statusBadge = '<span class="badge bg-success">Sudah Diisi</span>';
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${trx.tanggal}</td>
                <td>${trx.toko}</td>
                <td>${trx.uraian}</td>
                <td class="text-center">${statusBadge}</td>
                <td class="text-center">
                    <button class="btn btn-primary btn-sm" onclick="openModalNomor('${id}', '${trx.toko}')">
                        <i class="fas fa-list-ol"></i> Input No
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function openModalNomor(trxId, pihakName) {
        // Reset Form
        document.getElementById('formNomorSurat').reset();
        document.getElementById('ns_id_trx').value = trxId;
        
        // Cek apakah Pihak adalah Tukang
        // Kita gunakan list Tukang dari cache dropdown
        let isTukang = false;
        if (CACHE_DROPDOWNS.tukang && CACHE_DROPDOWNS.tukang.includes(pihakName)) {
            isTukang = true;
        }
        
        // Atur UI berdasarkan Toko vs Tukang
        document.getElementById('ns_jenis_pihak').value = isTukang ? 'tukang' : 'toko';
        
        if (isTukang) {
            // Jika Tukang: Sembunyikan No Surat Masuk, Ubah Label
            document.getElementById('div_ns_masuk').classList.add('hidden');
            document.getElementById('lbl_ns_periksa').innerText = "Pekerjaan"; // BA Pemeriksaan Pekerjaan
            document.getElementById('lbl_ns_terima').innerText = "Pekerjaan";  // BA Serah Terima Pekerjaan
        } else {
            // Jika Toko: Tampilkan No Surat Masuk, Ubah Label
            document.getElementById('div_ns_masuk').classList.remove('hidden');
            document.getElementById('lbl_ns_periksa').innerText = "Barang";
            document.getElementById('lbl_ns_terima').innerText = "Barang";
        }

        // Isi data jika sudah ada
        const saved = CACHE_NOMOR_SURAT[trxId];
        if (saved) {
            document.getElementById('ns_keluar').value = saved.keluar || '';
            document.getElementById('ns_masuk').value = saved.masuk || '';
            document.getElementById('ns_periksa').value = saved.periksa || '';
            document.getElementById('ns_terima').value = saved.terima || '';
            document.getElementById('ns_bayar').value = saved.bayar || '';
        }

        // Tampilkan Modal
        const myModal = new bootstrap.Modal(document.getElementById('modalNomorSurat'));
        myModal.show();
    }

    function simpanNomorSurat(e) {
        e.preventDefault();
        loader(true);
        
        const f = e.target;
        const data = {
            id_trx: f.id_trx.value,
            no_keluar: f.no_keluar.value,
            no_masuk: f.no_masuk.value,
            no_periksa: f.no_periksa.value,
            no_terima: f.no_terima.value,
            no_bayar: f.no_bayar.value
        };
        
        google.script.run.withSuccessHandler(res => {
            loader(false);
            // Tutup Modal
            const modalEl = document.getElementById('modalNomorSurat');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            
            // Refresh Tabel
            loadPengaturanNomor();
            alert(res);
        }).saveNomorSuratData(DB_ID, data);
    }
</script>
