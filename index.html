<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <?!= include('Stylesheet'); ?>
</head>
<body class="bg-light">

  <div id="loader" class="loading-overlay">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-2 fw-bold">Memproses Data...</div>
  </div>

  <div id="authContainer" class="container d-flex justify-content-center align-items-center vh-100">
    <div class="card shadow-lg p-4" style="width: 400px;">
      <h4 class="text-center mb-3 fw-bold text-primary">SISTEM LPJ BOS</h4>
      <ul class="nav nav-tabs nav-fill mb-3">
        <li class="nav-item"><button class="nav-link active" id="btnTabLogin" onclick="switchAuth('login')">Login</button></li>
        <li class="nav-item"><button class="nav-link" id="btnTabReg" onclick="switchAuth('register')">Daftar</button></li>
      </ul>
      <form id="formLogin" onsubmit="handleLogin(event)">
        <div class="mb-3"><input type="email" name="email" class="form-control" placeholder="Email" required></div>
        <div class="mb-3"><input type="password" name="password" class="form-control" placeholder="Password" required></div>
        <button type="submit" class="btn btn-primary w-100">Masuk Aplikasi</button>
      </form>
      <form id="formRegister" class="hidden" onsubmit="handleRegister(event)">
        <div class="mb-3"><input type="text" name="sekolah" class="form-control" placeholder="Nama Sekolah Lengkap" required></div>
        <div class="mb-3"><input type="email" name="email" class="form-control" placeholder="Email Aktif" required></div>
        <div class="mb-3"><input type="password" name="password" class="form-control" placeholder="Password" required></div>
        <button type="submit" class="btn btn-success w-100">Buat Akun & Database</button>
      </form>
    </div>
  </div>

  <div class="d-flex hidden" id="wrapper">
    <div class="bg-dark text-white border-end" id="sidebar-wrapper" style="width:250px;">
      <div class="sidebar-heading border-bottom bg-primary">LPJ BOS v2.0</div>
      <div class="p-3 border-bottom">
        <small class="text-white-50">Login sebagai:</small><br>
        <strong id="displaySekolah">Nama Sekolah</strong>
      </div>
      <div class="list-group list-group-flush mt-2">
        <button class="sidebar-btn" onclick="openView('dashboard')"><i class="fas fa-home"></i> Dashboard</button>
        <button class="sidebar-btn" onclick="openView('sekolah')"><i class="fas fa-school"></i> Data Sekolah</button>
        <button class="sidebar-btn" onclick="openView('master')"><i class="fas fa-database"></i> Data Master</button>
        <button class="sidebar-btn" onclick="openView('transaksi')"><i class="fas fa-shopping-cart"></i> Input Transaksi</button>
        <button class="sidebar-btn" onclick="openView('pengaturan')"><i class="fas fa-cogs"></i> Pengaturan Cetak</button>
        
        <button class="sidebar-btn" onclick="openView('cetak')"><i class="fas fa-print"></i> Cetak Laporan</button>
        <button class="sidebar-btn text-danger mt-4" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>

    <div id="page-content-wrapper">
      <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
        <div class="container-fluid">
          <button class="btn btn-primary" id="sidebarToggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        </div>
      </nav>

      <div class="container-fluid p-4">
        
        <div id="view-dashboard" class="app-view">
          <h3>Ringkasan Keuangan</h3>
          <div class="row mt-4">
            <div class="col-md-3">
              <div class="card text-white bg-primary mb-3 shadow">
                <div class="card-header">Total Anggaran</div>
                <div class="card-body"><h4 class="card-title" id="dashAnggaran">Rp. 0</h4></div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-warning mb-3 shadow">
                <div class="card-header">Total Belanja</div>
                <div class="card-body"><h4 class="card-title" id="dashBelanja">Rp. 0</h4></div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-success mb-3 shadow" id="cardSisa">
                <div class="card-header">Sisa Anggaran</div>
                <div class="card-body"><h4 class="card-title" id="dashSisa">Rp. 0</h4></div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-info mb-3 shadow">
                <div class="card-header">Jumlah Transaksi</div>
                <div class="card-body"><h4 class="card-title" id="dashCount">0</h4></div>
              </div>
            </div>
          </div>
        </div>

        <div id="view-sekolah" class="app-view hidden">
          <div class="card shadow">
            <div class="card-header bg-primary text-white">Identitas Sekolah</div>
            <div class="card-body">
              <form id="formSekolah" onsubmit="simpanSekolah(event)">
                <div class="row">
                  <div class="col-12 mb-3">
                    <label class="fw-bold">Total Anggaran (1 Tahun)</label>
                    <div class="input-group">
                      <span class="input-group-text">Rp</span>
                      <input type="number" name="total_anggaran" class="form-control" placeholder="Contoh: 50000000">
                    </div>
                    <small class="text-muted">Masukkan angka saja tanpa titik/koma.</small>
                  </div>
                  <hr>
                  <div class="col-md-6 mb-3"><label>Nama Kepala Sekolah</label><input type="text" name="kepsek" class="form-control"></div>
                  <div class="col-md-6 mb-3"><label>NIP Kepala Sekolah</label><input type="text" name="nip_kepsek" class="form-control"></div>
                  <div class="col-md-6 mb-3"><label>Nama Bendahara</label><input type="text" name="bendahara" class="form-control"></div>
                  <div class="col-md-6 mb-3"><label>NIP Bendahara</label><input type="text" name="nip_bendahara" class="form-control"></div>
                  <div class="col-12 mb-3"><label>Alamat Lengkap</label><textarea name="alamat" class="form-control" rows="3"></textarea></div>
                </div>
                <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
              </form>
            </div>
          </div>
        </div>

        <div id="view-transaksi" class="app-view hidden">
          <h3 id="titleTrx">Input Transaksi Belanja</h3>
          
          <form id="formTrx" onsubmit="simpanTransaksi(event)">
            <div class="card mb-3 shadow-sm">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs">
                        <li class="nav-item"><button class="nav-link active" id="tabBelanja" type="button" onclick="switchTrxMode('belanja')">Belanja (Toko)</button></li>
                        <li class="nav-item"><button class="nav-link" id="tabTukang" type="button" onclick="switchTrxMode('tukang')">Jasa (Tukang)</button></li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3"><label class="form-label">Tanggal</label><input type="date" name="tanggal" id="trxTanggal" class="form-control" required></div>
                        <div class="col-md-3">
                            <label class="form-label" id="lblPihak">Toko</label>
                            <select name="toko" class="form-select" id="trxPihak" required><option value="">Pilih...</option></select>
                        </div>
                        <div class="col-md-4"><label class="form-label">Uraian</label><select name="uraian" class="form-select" id="trxUraian" required><option value="">Pilih Uraian...</option></select></div>
                        <div class="col-md-2"><label class="form-label">No. Bukti</label><input type="text" name="no_bukti" id="trxBukti" class="form-control"></div>
                    </div>
                </div>
            </div>
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <table class="table table-bordered mb-0">
                        <thead class="table-light"><tr><th>Barang</th><th width="80">Vol</th><th width="80">Sat</th><th>Harga</th><th>Total</th><th>#</th></tr></thead>
                        <tbody id="trxBody"></tbody>
                        <tfoot class="table-light"><tr><td colspan="4" class="text-end fw-bold">TOTAL:</td><td class="fw-bold" id="grandTotal">0</td><td></td></tr></tfoot>
                    </table>
                </div>
                <div class="card-footer"><button type="button" class="btn btn-success btn-sm" onclick="addRow()">+ Item</button> <button type="submit" class="btn btn-primary btn-sm float-end">SIMPAN</button></div>
            </div>
          </form>

          <div class="card mt-4 shadow-sm border-0">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
              <span><i class="fas fa-history"></i> Riwayat Input Terakhir</span>
              <button class="btn btn-sm btn-light py-0" onclick="loadRiwayat()"><i class="fas fa-sync"></i> Refresh</button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-striped table-hover mb-0" id="tableRiwayat">
                    <thead class="table-light"><tr><th>Tanggal</th><th>Toko / Pihak</th><th>Uraian</th><th style="min-width: 300px;">Detail Barang</th><th class="text-end">Total</th><th class="text-center">Aksi</th></tr></thead>
                    <tbody id="tbody_riwayat"><tr><td colspan="6" class="text-center p-3">Memuat data...</td></tr></tbody>
                  </table>
                </div>
            </div>
          </div>
        </div>

        <div id="view-pengaturan" class="app-view hidden">
            <h3>Pengaturan Cetak</h3>
            <div class="card shadow-sm mt-3">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="settingTabs">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-kop">Kop Surat</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-nomor" onclick="loadPengaturanNomor()">Nomor Surat</button></li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-tanggal" onclick="loadPengaturanTanggal()">Pengaturan Tanggal</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-kop">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Upload Kop Surat (JPG/PNG)</label>
                                    <input type="file" id="fileKop" class="form-control mb-3" accept="image/*" onchange="previewKop(this)">
                                    <button class="btn btn-primary" onclick="uploadKopSurat()">Simpan Kop Surat</button>
                                </div>
                                <div class="col-md-6 text-center">
                                    <label class="form-label text-muted">Preview:</label>
                                    <div class="border p-2 bg-light" style="min-height: 150px;">
                                        <img id="previewImgKop" src="" class="img-fluid" style="max-height: 200px; display:none;">
                                        <p id="noKopText" class="text-muted mt-5">Belum ada kop surat</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-nomor">
                            <div class="alert alert-info py-2"><small><i class="fas fa-info-circle"></i> Klik tombol "Input No" pada transaksi untuk melengkapi nomor surat.</small></div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0">
                                    <thead class="table-dark"><tr><th>Tanggal</th><th>Pihak (Toko/Tukang)</th><th>Uraian</th><th class="text-center">Status Nomor</th><th class="text-center">Aksi</th></tr></thead>
                                    <tbody id="tbody_setting_nomor"><tr><td colspan="5" class="text-center">Memuat data...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-tanggal">
                            <div class="alert alert-warning py-2"><small><i class="fas fa-calendar-alt"></i> Atur tanggal dokumen pendukung di sini. Tanggal Transaksi (Kuitansi) mengikuti input awal.</small></div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Tgl Trx</th>
                                            <th>Pihak (Toko/Tukang)</th>
                                            <th>Uraian</th>
                                            <th class="text-center">Status Tanggal</th>
                                            <th class="text-center">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody_setting_tanggal">
                                        <tr><td colspan="5" class="text-center">Klik tab ini untuk memuat data...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="view-master" class="app-view hidden">
          <h3 class="mb-4">Kelola Data Master</h3>
          <ul class="nav nav-tabs" id="masterTabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-uraian" type="button" onclick="loadMasterTable('Data_Uraian')">Uraian Belanja</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-toko" type="button" onclick="loadMasterTable('Data_Toko')">Data Toko</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-tukang" type="button" onclick="loadMasterTable('Data_Tukang')">Data Tukang</button></li>
          </ul>
          <div class="tab-content p-3 border border-top-0 bg-white shadow-sm rounded-bottom">
            <div class="tab-pane fade show active" id="tab-uraian">
                <div class="row"><div class="col-md-4 mb-3"><div class="card bg-light"><div class="card-body"><h6 class="fw-bold">Form Uraian</h6><form onsubmit="simpanMaster(event, 'Data_Uraian')"><input type="hidden" name="rowIndex" id="idx_Data_Uraian"><input type="text" name="kode" id="u_kode" class="form-control mb-2" placeholder="Kode"><input type="text" name="nama" id="u_nama" class="form-control mb-2" placeholder="Nama Uraian" required><button type="submit" class="btn btn-primary w-100 btn-sm" id="btn_Data_Uraian">Simpan</button><button type="button" class="btn btn-secondary w-100 btn-sm mt-1 hidden" id="cancel_Data_Uraian" onclick="resetFormMaster('Data_Uraian')">Batal</button></form></div></div></div><div class="col-md-8"><table class="table table-striped table-sm"><thead><tr class="table-primary"><th>Kode</th><th>Nama</th><th>Aksi</th></tr></thead><tbody id="tbody_Data_Uraian"></tbody></table></div></div>
            </div>
            <div class="tab-pane fade" id="tab-toko">
                 <div class="row"><div class="col-md-4 mb-3"><div class="card bg-light"><div class="card-body"><h6 class="fw-bold">Form Toko</h6><form onsubmit="simpanMaster(event, 'Data_Toko')"><input type="hidden" name="rowIndex" id="idx_Data_Toko"><input type="text" name="nama" id="t_nama" class="form-control form-control-sm mb-1" placeholder="Nama Toko" required><input type="text" name="jenis" id="t_jenis" class="form-control form-control-sm mb-1" placeholder="Jenis (ATK/Bangunan)"><textarea name="alamat" id="t_alamat" class="form-control form-control-sm mb-1" placeholder="Alamat" rows="2"></textarea><input type="text" name="telp" id="t_telp" class="form-control form-control-sm mb-1" placeholder="No. Telp"><input type="text" name="pemilik" id="t_pemilik" class="form-control form-control-sm mb-1" placeholder="Nama Pemilik"><label class="small text-muted">Tanggal TTD</label><input type="date" name="tgl_ttd" id="t_tgl_ttd" class="form-control form-control-sm mb-2"><button type="submit" class="btn btn-primary w-100 btn-sm" id="btn_Data_Toko">Simpan</button><button type="button" class="btn btn-secondary w-100 btn-sm mt-1 hidden" id="cancel_Data_Toko" onclick="resetFormMaster('Data_Toko')">Batal</button></form></div></div></div><div class="col-md-8"><div class="table-responsive"><table class="table table-striped table-sm" style="font-size:0.85rem"><thead><tr class="table-success"><th>Toko & Jenis</th><th>Alamat & Telp</th><th>Pemilik</th><th>Aksi</th></tr></thead><tbody id="tbody_Data_Toko"></tbody></table></div></div></div>
            </div>
            <div class="tab-pane fade" id="tab-tukang">
                <div class="row"><div class="col-md-4 mb-3"><div class="card bg-light"><div class="card-body"><h6 class="fw-bold">Form Tukang</h6><form onsubmit="simpanMaster(event, 'Data_Tukang')"><input type="hidden" name="rowIndex" id="idx_Data_Tukang"><input type="text" name="nama" id="k_nama" class="form-control mb-2" placeholder="Nama" required><textarea name="alamat" id="k_alamat" class="form-control mb-2" placeholder="Alamat" rows="2"></textarea><button type="submit" class="btn btn-primary w-100 btn-sm" id="btn_Data_Tukang">Simpan</button><button type="button" class="btn btn-secondary w-100 btn-sm mt-1 hidden" id="cancel_Data_Tukang" onclick="resetFormMaster('Data_Tukang')">Batal</button></form></div></div></div><div class="col-md-8"><table class="table table-striped table-sm"><thead><tr class="table-warning"><th>Nama</th><th>Alamat</th><th>Aksi</th></tr></thead><tbody id="tbody_Data_Tukang"></tbody></table></div></div>
            </div>
          </div>
        </div>

        <div id="view-cetak" class="app-view hidden">
            <div class="card shadow" style="max-width:600px; margin: 0 auto;">
                <div class="card-header bg-dark text-white">Cetak Laporan</div>
                <div class="card-body">
                    <p>Silakan pilih periode laporan yang ingin dicetak.</p>
                    <div class="mb-3"><label>Bulan / Periode</label><input type="month" class="form-control"></div>
                    <div class="mb-3"><label>Jenis Laporan</label><select class="form-select"><option>BKU (Buku Kas Umum)</option><option>Kwitansi</option><option>Rincian Objek Belanja</option></select></div>
                    <button class="btn btn-primary w-100" onclick="alert('Fungsi Generate PDF akan diimplementasikan nanti')"><i class="fas fa-file-pdf"></i> Download Laporan</button>
                </div>
            </div>
        </div>

      </div>
    </div>
  </div>

  <div class="modal fade" id="modalNomorSurat" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Input Nomor Surat</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNomorSurat" onsubmit="simpanNomorSurat(event)">
                    <input type="hidden" name="id_trx" id="ns_id_trx">
                    <input type="hidden" id="ns_jenis_pihak"> <div class="mb-3">
                        <label class="fw-bold">1. Nomor Surat Keluar (Madrasah/Sekolah)</label>
                        <input type="text" name="no_keluar" id="ns_keluar" class="form-control" placeholder="Contoh: 001/Mts.01/.../2025">
                    </div>

                    <div class="mb-3" id="div_ns_masuk">
                        <label class="fw-bold">2. Nomor Surat Masuk / Nota (Dari Toko)</label>
                        <input type="text" name="no_masuk" id="ns_masuk" class="form-control" placeholder="Nomor Nota/Faktur">
                        <small class="text-muted">* Kosongkan jika Pihak adalah Tukang</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold">3. No. BA Pemeriksaan <span id="lbl_ns_periksa">Barang</span></label>
                            <input type="text" name="no_periksa" id="ns_periksa" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold">4. No. BA Serah Terima <span id="lbl_ns_terima">Barang</span></label>
                            <input type="text" name="no_terima" id="ns_terima" class="form-control">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold">5. Nomor BA Pembayaran</label>
                        <input type="text" name="no_bayar" id="ns_bayar" class="form-control">
                    </div>

                    <div class="modal-footer px-0 pb-0">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-success">Simpan Nomor</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="modalTanggalSurat" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Set Tanggal Dokumen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formTanggalSurat" onsubmit="simpanTanggalSurat(event)">
                    <input type="hidden" name="id_trx" id="ts_id_trx">
                    <input type="hidden" id="ts_jenis_pihak"> <div class="mb-3" id="div_ts_masuk">
                        <label class="fw-bold">1. Tanggal Nota/Faktur (Dari Toko)</label>
                        <input type="date" name="tgl_masuk" id="ts_masuk" class="form-control">
                        <small class="text-muted">* Kosongkan jika Pihak adalah Tukang</small>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold">2. Tanggal BA Pemeriksaan <span id="lbl_ts_periksa">Barang</span></label>
                        <input type="date" name="tgl_periksa" id="ts_periksa" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold">3. Tanggal BA Serah Terima <span id="lbl_ts_terima">Barang</span></label>
                        <input type="date" name="tgl_terima" id="ts_terima" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold">4. Tanggal BA Pembayaran</label>
                        <input type="date" name="tgl_bayar" id="ts_bayar" class="form-control">
                    </div>

                    <div class="modal-footer px-0 pb-0">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-warning">Simpan Tanggal</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <?!= include('JavaScript'); ?>
</body>
</html>
